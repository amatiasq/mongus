{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./node_modules/@amatiasq/emitter/emitter.ts","webpack:///./src/ui.ts","webpack:///./src/users.ts","webpack:///../shared/communication/ClientMessage.ts","webpack:///../shared/communication/ClientToClientMessage.ts","webpack:///./src/audio.ts","webpack:///./src/assets.ts","webpack:///./src/User.ts","webpack:///./src/index.ts","webpack:///../shared/communication/RoomMessage.ts","webpack:///../shared/communication/ServerMessage.ts","webpack:///./src/game.ts","webpack:///./src/canvas.ts","webpack:///./src/Color.ts","webpack:///./src/interaction.ts","webpack:///./node_modules/@amatiasq/keyboard/KeyboardController.ts","webpack:///./node_modules/@amatiasq/keyboard/KeyCode.ts","webpack:///./src/PeerChannel.ts","webpack:///./node_modules/@amatiasq/peer-connection/PeerConnection.ts","webpack:///./node_modules/freeice/index.js","webpack:///./node_modules/normalice/index.js","webpack:///./src/Socket.ts","webpack:///./node_modules/@amatiasq/json-socket/JsonSocket.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","emitter","listeners","Set","subscribe","emit","data","forEach","listener","add","delete","onUserClicked","$","selector","document","querySelector","userList","canvas","parent","parentElement","window","addEventListener","fill","width","clientWidth","height","clientHeight","stored","sessionStorage","getItem","e","removeItem","location","reload","Promise","resolve","$dialog","$form","$input","showModal","reject","trim","setItem","innerHTML","question","$template","importNode","content","firstElementChild","body","appendChild","then","result","remove","renderUsers","users","user","el","createElement","suffix","isCalling","button","onclick","getUserById","id","find","x","unserializeUser","User","refreshUserList","list","map","console","log","push","filter","ClientMessageType","ClientToClientMessageType","navigator","mediaDevices","getUserMedia","audio","stream","srcObject","prepareAudio","play","loadImage","url","img","Image","onload","onerror","src","serialized","position","y","connection","this","Boolean","callStarted","acceptAnswer","answer","hangup","end","dispose","ServerMessageType","socket","Socket","getValidUser","send","type","ERROR","message","whenUserClicked","conn","PeerChannel","captureAudio","getTracks","addTrack","sendOffer","callUser","init","onMessage","HANDSHAKE","getUserName","renderUsername","LOGIN","LOGIN_RESULT","success","alert","clear","setUserList","me","frame","before","runFrame","SEND_TO_ROOM","RoomMessageType","POSITION_CHANGED","requestAnimationFrame","startGame","handleLoginResult","USER_CONNECTED","userConnected","USER_DISCONNECTED","userDisconnected","MESSAGE_TO_ROOM","from","updatePosition","MESSAGE_FROM_USER","RPC_OFFER","offer","confirm","acceptOffer","SEND_TO_USER","to","REJECT_OFFER","receiveOffer","RPC_ANSWER","keyboard","isActive","Action","UP","DOWN","LEFT","RIGHT","movePlayer","others","getUserList","render","player","getCanvas","context","getContext","renderPlayer","image","drawImage","fillStyle","fillRect","save","translate","otherColors","getColoredPlayer","Color","GREEN","selfColor","restore","cache","Map","color","rgba","toRgba","has","dark","g","b","getImageData","length","pixel","isReddish","setTo","isBlueish","isPurpleish","putImageData","set","a","isPredominant","isPredominantOver","is","other","index","RED","BLUE","KeyboardController","setDirections","KeyCode","addListener","code","triggerListeners","event","keymap","actions","codeToKey","onKeyDownListeners","onKeyUpListeners","handleKeyDown","handleKeyUp","action","up","down","left","right","setArrows","setWSAD","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyW","KeyS","KeyA","KeyD","onEvent","getActionFor","createRtc","createOffer","offerToReceiveAudio","addStream","track","close","PeerConnection","onTrackReceived","playAudio","streams","rtc","onDataChannel","options","setLocalDescription","processIceCandidates","localDescription","setRemoteDescription","createAnswer","RTCPeerConnection","iceServers","ontrack","ondatachannel","onicecandidate","candidate","desc","RTCSessionDescription","normalice","opts","selected","servers","stun","turn","stunCount","turnCount","getServers","count","idx","out","input","concat","Math","random","splice","String","protocols","protocol","parts","output","indexOf","slice","split","username","credential","urls","uri","JsonSocket","processMessage","debug","RECONNECTION_DELAY","MAX_RECONNECT_ATTEMPTS","reconnectionDelay","reconnectAttempts","disconnectedAt","Date","isReconnecting","isFirstConnection","ws","onOpen","onReconnect","WebSocket","onopen","connectionOpen","onmessage","connectionLost","onclose","JSON","stringify","parse","error","reconnecting","singleLine","setTimeout"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 8);\n","export function emitter<T = any>() {\n  const listeners = new Set<(data: T) => void>();\n  subscribe.emit = emit;\n  return subscribe;\n\n  function emit(data: T) {\n    listeners.forEach(listener => listener(data));\n  }\n\n  function subscribe(listener: (data: T) => void) {\n    listeners.add(listener);\n    return () => listeners.delete(listener);\n  }\n}\n","import { UserName } from '../../shared/types';\nimport { User } from './User';\n\nconst $ = <T extends HTMLElement = HTMLElement>(selector: string) =>\n  document.querySelector(selector) as T;\n\nconst userList = $('#userlist');\nlet onUserClicked: Function;\n\nexport function whenUserClicked(listener: Function) {\n  onUserClicked = listener;\n}\n\nexport function getCanvas() {\n  const canvas = $<HTMLCanvasElement>('canvas');\n  const parent = canvas.parentElement!;\n\n  window.addEventListener('resize', fill);\n  fill();\n\n  return canvas;\n\n  function fill() {\n    canvas.width = parent.clientWidth;\n    canvas.height = parent.clientHeight;\n  }\n}\n\nexport async function getUserName() {\n  const key = 'amongus:username';\n  const stored = sessionStorage.getItem(key);\n\n  $('#logout')!.addEventListener('click', e => {\n    sessionStorage.removeItem(key);\n    location.reload();\n  });\n\n  if (stored) {\n    return Promise.resolve(stored as UserName);\n  }\n\n  const $dialog = $<HTMLDialogElement>('#login');\n  const $form = $dialog.querySelector('form') as HTMLFormElement;\n  const $input = $form?.querySelector('input[type=text]') as HTMLInputElement;\n\n  $dialog.showModal();\n\n  return new Promise<UserName>((resolve, reject) => {\n    $form.addEventListener('submit', e => {\n      const value = $input.value.trim();\n      sessionStorage.setItem(key, value);\n      resolve(value as UserName);\n    });\n  });\n}\n\nexport function renderUsername(name: string) {\n  const parent = $('#username');\n  parent.innerHTML = name;\n}\n\nexport function confirm(question: string) {\n  const $template = $<HTMLTemplateElement>('#confirm-dialog');\n  const $dialog = document.importNode($template.content, true)\n    .firstElementChild as HTMLDialogElement;\n\n  document.body.appendChild($dialog);\n\n  const get = (selector: string) => $dialog.querySelector(selector)!;\n  get('.question')!.innerHTML = question;\n\n  return new Promise(resolve => {\n    get('.yes')!.addEventListener('click', () => resolve(true));\n    get('.no')!.addEventListener('click', () => resolve(false));\n    $dialog.showModal();\n  }).then(result => {\n    $dialog.remove();\n    return result;\n  });\n}\n\nexport function renderUsers(users: User[]) {\n  userList.innerHTML = '';\n\n  for (const user of users) {\n    const el = document.createElement('div');\n\n    const buttonClick = async () => {\n      await onUserClicked(user);\n      renderUsers(users);\n    };\n\n    const suffix = user.isCalling ? '(llamando...)' : '';\n\n    const button = document.createElement('button');\n    button.innerHTML = `${user.name} ${suffix}`;\n    button.onclick = buttonClick;\n    el.appendChild(button);\n\n    userList.appendChild(el);\n  }\n}\n","import { SerializedUser } from '../../shared/SerializedUser';\nimport { renderUsers } from './ui';\nimport { UserId, UserName } from '../../shared/types';\nimport { User } from './User';\n\nlet users: User[] = [];\n\nexport function getUserById(id: UserId) {\n  return users.find(x => x.id === id);\n}\n\nexport function getUserByName(name: UserName) {\n  return users.find(x => x.name === name);\n}\n\nexport function setUserList(list: SerializedUser[]) {\n  users = list.map(unserializeUser).map(x => getUserById(x.id) || x);\n  refreshUserList();\n}\n\nfunction unserializeUser(user: SerializedUser) {\n  return new User(user);\n}\n\nexport function userConnected(user: SerializedUser) {\n  console.log('CONNECTED', user);\n  users.push(unserializeUser(user));\n  refreshUserList();\n}\n\nexport function userDisconnected(user: SerializedUser) {\n  console.log('DISCONNECTED', user);\n  users = users.filter(x => x.id !== user.id);\n  refreshUserList();\n}\n\nexport function getUserList() {\n  return users;\n}\n\nexport function refreshUserList() {\n  renderUsers(users);\n}\n","import { RoomMessage } from './RoomMessage';\nimport { UserId, UserName } from '../types';\nimport { ClientToClientMessage } from './ClientToClientMessage';\n\nexport enum ClientMessageType {\n  ERROR = 'ERROR',\n  LOGIN = 'LOGIN',\n  LOGOUT = 'LOGOUT',\n  SEND_TO_USER = 'SEND_TO_USER',\n  SEND_TO_ROOM = 'SEND_TO_ROOM',\n}\n\ninterface ClientMessage__ERROR {\n  type: ClientMessageType.ERROR;\n  message: string;\n}\n\ninterface ClientMessage__LOGIN {\n  type: ClientMessageType.LOGIN;\n  name: UserName;\n}\n\ninterface ClientMessage__LOGOUT {\n  type: ClientMessageType.LOGOUT;\n}\n\ninterface ClientMessage__SEND_TO_ROOM {\n  type: ClientMessageType.SEND_TO_ROOM;\n  message: RoomMessage;\n}\n\ninterface ClientMessage__SEND_TO_USER {\n  type: ClientMessageType.SEND_TO_USER;\n  to: UserId;\n  message: ClientToClientMessage;\n}\n\nexport type ClientMessage =\n  | ClientMessage__ERROR\n  | ClientMessage__LOGIN\n  | ClientMessage__LOGOUT\n  | ClientMessage__SEND_TO_ROOM\n  | ClientMessage__SEND_TO_USER;\n","export enum ClientToClientMessageType {\n  RPC_OFFER = 'SEND_OFFER',\n  RPC_ANSWER = 'SEND_ANSWER',\n  REJECT_OFFER = 'REJECT_OFFER',\n}\n\ninterface ClientToClientMessage__RPC_OFFER {\n  type: ClientToClientMessageType.RPC_OFFER;\n  offer: RTCSessionDescription;\n}\n\ninterface ClientToClientMessage__RPC_ANSWER {\n  type: ClientToClientMessageType.RPC_ANSWER;\n  answer: RTCSessionDescription;\n}\n\ninterface ClientToClientMessage__REJECT_OFFER {\n  type: ClientToClientMessageType.REJECT_OFFER;\n}\n\nexport type ClientToClientMessage =\n  | ClientToClientMessage__RPC_OFFER\n  | ClientToClientMessage__RPC_ANSWER\n  | ClientToClientMessage__REJECT_OFFER;\n","export function captureAudio() {\n  return navigator.mediaDevices.getUserMedia({ audio: true });\n}\n\nexport async function playAudio(stream: MediaStream) {\n  const audio = prepareAudio(stream);\n  await audio.play();\n}\n\nfunction prepareAudio(stream: MediaStream) {\n  const audio = document.createElement('audio');\n  audio.srcObject = stream;\n  document.body.appendChild(audio);\n  return audio;\n}\n","export function init() {\n  loadImage('../assets/sprites/player.png').then(x => {\n    document.appendChild(x);\n  });\n}\n\nexport function loadImage(url: string) {\n  const img = new Image();\n\n  return new Promise<HTMLImageElement>((resolve, reject) => {\n    img.onload = () => resolve(img);\n    img.onerror = reject;\n    img.src = url;\n  });\n}\n","import { SerializedUser } from '../../shared/SerializedUser';\nimport { PeerChannel } from './PeerChannel';\n\nexport class User implements SerializedUser {\n  id;\n  name;\n  position = { x: 0, y: 0 };\n\n  private connection: PeerChannel | null = null;\n\n  get isCalling() {\n    return Boolean(this.connection);\n  }\n\n  constructor(serialized: SerializedUser) {\n    this.id = serialized.id;\n    this.name = serialized.name;\n  }\n\n  callStarted(connection: PeerChannel) {\n    this.connection = connection;\n  }\n\n  acceptAnswer(answer: RTCSessionDescription): void {\n    this.connection!.acceptAnswer(answer);\n  }\n\n  hangup() {\n    this.connection?.end();\n    this.connection = null;\n  }\n\n  dispose() {\n    this.hangup();\n  }\n}\n","import {\n  RoomMessage,\n  RoomMessageType,\n} from './../../shared/communication/RoomMessage';\nimport { ClientMessageType } from '../../shared/communication/ClientMessage';\nimport { ClientToClientMessageType } from '../../shared/communication/ClientToClientMessage';\nimport {\n  ServerMessage,\n  ServerMessageType,\n} from '../../shared/communication/ServerMessage';\nimport { UserName, UserId } from '../../shared/types';\nimport { captureAudio } from './audio';\nimport { runFrame } from './game';\nimport { PeerChannel } from './PeerChannel';\nimport { Socket } from './Socket';\nimport { getUserName, renderUsername, whenUserClicked } from './ui';\nimport { User } from './User';\nimport {\n  getUserById,\n  setUserList,\n  userConnected,\n  userDisconnected,\n} from './users';\nimport { Vector } from '../../shared/Vector';\nimport { init } from './assets';\n\nconst t = ServerMessageType;\n// const socket = new Socket('ws://localhost:17965');\nconst socket = new Socket('wss://amongus.amatiasq.com');\n\nwhenUserClicked(toggleCall);\ninit();\n\nsocket.onMessage(t.HANDSHAKE, login);\nsocket.onMessage(t.LOGIN_RESULT, data => handleLoginResult(data));\nsocket.onMessage(t.USER_CONNECTED, data => userConnected(data.user));\nsocket.onMessage(t.USER_DISCONNECTED, data => userDisconnected(data.user));\n\nsocket.onMessage(t.MESSAGE_TO_ROOM, ({ from, message }) => {\n  const user = getValidUser(from);\n  if (!user) return;\n\n  switch (message.type) {\n    case RoomMessageType.POSITION_CHANGED:\n      return updatePosition(user, message.position);\n  }\n});\n\nsocket.onMessage(t.MESSAGE_FROM_USER, ({ from, message }) => {\n  const user = getValidUser(from);\n  if (!user) return;\n\n  switch (message.type) {\n    case ClientToClientMessageType.RPC_OFFER:\n      return receiveOffer(user, message.offer);\n    case ClientToClientMessageType.RPC_ANSWER:\n      return user.acceptAnswer(message.answer);\n    case ClientToClientMessageType.REJECT_OFFER:\n      return user.hangup();\n  }\n});\n\nasync function login() {\n  const name = await getUserName();\n  renderUsername(name);\n  socket.send({ type: ClientMessageType.LOGIN, name });\n}\n\nfunction handleLoginResult(data: ServerMessage) {\n  if (data.type !== ServerMessageType.LOGIN_RESULT) {\n    return;\n  }\n\n  if (!data.success) {\n    alert(data.message);\n    sessionStorage.clear();\n    location.reload();\n    return;\n  }\n\n  setUserList(data.users);\n  startGame(data.name);\n}\n\nfunction startGame(name: UserName) {\n  const me = new User({ id: 'me' as UserId, name });\n\n  frame();\n\n  function frame() {\n    const before = { ...me.position };\n    runFrame(me);\n\n    if (before.x !== me.position.x || before.y !== me.position.y) {\n      socket.send({\n        type: ClientMessageType.SEND_TO_ROOM,\n        message: {\n          type: RoomMessageType.POSITION_CHANGED,\n          position: me.position,\n        },\n      });\n    }\n\n    requestAnimationFrame(frame);\n  }\n}\n\nfunction updatePosition(user: User, position: Vector) {\n  user.position = position;\n}\n\nfunction toggleCall(user: User) {\n  return user.isCalling ? user.hangup() : callUser(user);\n}\n\nasync function callUser(user: User) {\n  const conn = new PeerChannel(user, m => socket.send(m));\n  const stream = await captureAudio();\n\n  stream.getTracks().forEach(x => conn.addTrack(x, stream));\n  conn.sendOffer();\n\n  user.callStarted(conn);\n  return conn;\n}\n\nasync function receiveOffer(user: User, offer: RTCSessionDescription) {\n  console.log(`${user.name} quiere iniciar una llamada`);\n  const shouldAnswer = await confirm(\n    `${user.name} quiere iniciar una llamada.<br>Contestar?`,\n  );\n\n  if (!shouldAnswer) {\n    console.log(`Llamada de ${user.name} rechazada`);\n    socket.send({\n      type: ClientMessageType.SEND_TO_USER,\n      to: user.id,\n      message: { type: ClientToClientMessageType.REJECT_OFFER },\n    });\n    return;\n  }\n\n  console.log(`Llamada de ${user.name} aceptada`);\n  const conn = new PeerChannel(user, m => socket.send(m));\n\n  conn.acceptOffer(offer);\n  console.log(`Enviando respuesta a ${user.name}...`);\n\n  user.callStarted(conn);\n  return conn;\n}\n\nfunction getValidUser(id: UserId) {\n  const user = getUserById(id);\n\n  if (user) {\n    return user;\n  }\n\n  socket.send({\n    type: ClientMessageType.ERROR,\n    message: `Received message from unknown user ${id}`,\n  });\n}\n","import { Vector } from './../Vector';\n\nexport enum RoomMessageType {\n  POSITION_CHANGED = 'POSITION_CHANGED',\n}\n\ninterface RoomMessage__POSITION_CHANGED {\n  type: RoomMessageType.POSITION_CHANGED;\n  position: Vector;\n}\n\nexport type RoomMessage = RoomMessage__POSITION_CHANGED;\n","import { RoomMessage } from './RoomMessage';\nimport { SerializedUser } from '../SerializedUser';\nimport { UserId, UserName } from '../types';\nimport { ClientToClientMessage } from './ClientToClientMessage';\n\nexport enum ServerMessageType {\n  ERROR = 'ERROR',\n  HANDSHAKE = 'HANDSHAKE',\n  LOGIN_RESULT = 'LOGIN_RESULT',\n  USER_CONNECTED = 'USER_CONNECTED',\n  USER_DISCONNECTED = 'USER_DISCONNECTED',\n  MESSAGE_FROM_USER = 'MESSAGE_FROM_USER',\n  MESSAGE_TO_ROOM = 'MESSAGE_TO_ROOM',\n}\n\ninterface ServerMessage__ERROR {\n  type: ServerMessageType.ERROR;\n  message: string;\n}\n\ninterface ServerMessage__HANDSHAKE {\n  type: ServerMessageType.HANDSHAKE;\n}\n\ninterface ServerMessage__LOGIN_RESULT__SUCCESS {\n  type: ServerMessageType.LOGIN_RESULT;\n  success: true;\n  name: UserName;\n  users: SerializedUser[];\n}\n\ninterface ServerMessage__LOGIN_RESULT__FAIL {\n  type: ServerMessageType.LOGIN_RESULT;\n  success: false;\n  message: string;\n}\n\ninterface ServerMessage__USER_CONNECTED {\n  type: ServerMessageType.USER_CONNECTED;\n  user: SerializedUser;\n}\n\ninterface ServerMessage__USER_DISCONNECTED {\n  type: ServerMessageType.USER_DISCONNECTED;\n  user: SerializedUser;\n}\n\ninterface ServerMessage__MESSAGE_TO_ROOM {\n  type: ServerMessageType.MESSAGE_TO_ROOM;\n  from: UserId;\n  message: RoomMessage;\n}\n\ninterface ServerMessage__MESSAGE_FROM_USER {\n  type: ServerMessageType.MESSAGE_FROM_USER;\n  from: UserId;\n  message: ClientToClientMessage;\n}\n\nexport type ServerMessage =\n  | ServerMessage__ERROR\n  | ServerMessage__HANDSHAKE\n  | ServerMessage__LOGIN_RESULT__SUCCESS\n  | ServerMessage__LOGIN_RESULT__FAIL\n  | ServerMessage__USER_CONNECTED\n  | ServerMessage__USER_DISCONNECTED\n  | ServerMessage__MESSAGE_TO_ROOM\n  | ServerMessage__MESSAGE_FROM_USER;\n","import { Vector } from '../../shared/Vector';\nimport { render } from './canvas';\nimport { Action, keyboard } from './interaction';\nimport { User } from './User';\nimport { getUserList } from './users';\n\nconst SPEED = 5;\n\nexport function runFrame(user: User) {\n  movePlayer(user.position);\n  const others = getUserList().map(x => x.position);\n  render(user.position, others);\n}\n\nfunction movePlayer(position: Vector) {\n  if (keyboard.isActive(Action.UP)) position.y -= SPEED;\n  if (keyboard.isActive(Action.DOWN)) position.y += SPEED;\n  if (keyboard.isActive(Action.LEFT)) position.x -= SPEED;\n  if (keyboard.isActive(Action.RIGHT)) position.x += SPEED;\n}\n","import { Vector } from '../../shared/Vector';\nimport { loadImage } from './assets';\nimport { Color } from './Color';\nimport { getCanvas } from './ui';\n\nconst canvas = getCanvas();\nconst context = canvas.getContext('2d')!;\n\nlet player: HTMLImageElement;\nloadImage('../assets/sprites/player.png').then(x => (player = x));\n\nexport function render(user: Vector, others: Vector[]) {\n  context.fillStyle = 'black';\n  context.fillRect(0, 0, canvas.width, canvas.height);\n\n  context.save();\n  context.translate(canvas.width / 2, canvas.height / 2);\n\n  const otherColors = getColoredPlayer(Color.GREEN)!;\n  const selfColor = getColoredPlayer(Color.GREEN)!;\n\n  others.forEach(user => renderPlayer(user.x, user.y, otherColors));\n\n  renderPlayer(user.x, user.y, selfColor);\n\n  context.restore();\n}\n\nfunction renderPlayer(x: number, y: number, image: CanvasImageSource) {\n  context.drawImage(image, x, y);\n}\n\nconst cache = new Map<string, CanvasImageSource>();\n\nfunction getColoredPlayer(color: Color) {\n  const rgba = color.toRgba();\n\n  if (cache.has(rgba)) {\n    return cache.get(rgba);\n  }\n\n  const canvas = document.createElement('canvas');\n  const context = canvas.getContext('2d')!;\n  const { width, height } = player;\n\n  canvas.width = width;\n  canvas.height = height;\n  context.drawImage(player, 0, 0);\n\n  const dark = new Color(color.r, color.g, color.b, (1 / 255) * 100);\n\n  const image = context.getImageData(0, 0, width, height);\n  const { data } = image;\n\n  for (let i = 0; i < data.length; i += 4) {\n    const pixel = new Color(data[i + 0], data[i + 1], data[i + 2]);\n\n    if (pixel.isReddish) {\n      color.setTo(data, i);\n    } else if (pixel.isBlueish || pixel.isPurpleish) {\n      dark.setTo(data, i);\n    }\n  }\n\n  context.putImageData(image, 0, 0);\n\n  cache.set(rgba, canvas);\n  return canvas;\n}\n","export class Color {\n  static readonly RED = new Color(255, 0, 0);\n  static readonly GREEN = new Color(0, 255, 0);\n  static readonly BLUE = new Color(0, 0, 255);\n\n  get isReddish() {\n    return isPredominant(this.r, this.g, this.b);\n  }\n\n  get isBlueish() {\n    return isPredominant(this.b, this.r, this.g);\n  }\n\n  get isPurpleish() {\n    return (\n      isPredominantOver(this.r, this.g) && isPredominantOver(this.b, this.g)\n    );\n  }\n\n  constructor(\n    readonly r: number,\n    readonly g: number,\n    readonly b: number,\n    readonly a: number = 1,\n  ) {}\n\n  toRgba() {\n    return `rgba(${this.r},${this.g},${this.b},${this.a})`;\n  }\n\n  is(other: Color) {\n    return (\n      this.r === other.r &&\n      this.g === other.g &&\n      this.b === other.b &&\n      this.a === other.a\n    );\n  }\n\n  setTo(data: Uint8ClampedArray, index: number) {\n    data[index] = this.r;\n    data[index + 1] = this.g;\n    data[index + 2] = this.b;\n    data[index + 3] = this.a * 255;\n  }\n}\n\nfunction isPredominantOver(x: number, a: number) {\n  return x > 10 && x > a * 1.25;\n}\n\nfunction isPredominant(x: number, a: number, b: number) {\n  return x > 10 && x > a * 1.25 && x > b * 1.25;\n}\n","import { KeyboardController } from '@amatiasq/keyboard';\n\nexport enum Action {\n  UP,\n  DOWN,\n  LEFT,\n  RIGHT,\n}\n\nexport const keyboard = new KeyboardController<Action>();\n\nkeyboard.setDirections(Action.UP, Action.DOWN, Action.LEFT, Action.RIGHT);\n","import { KeyCode } from './KeyCode';\n\nexport { KeyCode };\n\ntype EnumDeclaration = number | string;\ntype Native = (event: KeyboardEvent) => void;\ntype ExtendedKeyboardEvent = KeyboardEvent & { code: KeyCode };\n\nexport class KeyboardController<T extends EnumDeclaration> {\n  private readonly keymap: { [id: string]: T } = {};\n  private readonly actions = new Set<T>();\n  private readonly codeToKey = new Map<KeyCode, string>();\n  private readonly onKeyDownListeners = new Map<KeyCode, Native[]>();\n  private readonly onKeyUpListeners = new Map<KeyCode, Native[]>();\n\n  constructor() {\n    this.handleKeyDown = this.handleKeyDown.bind(this);\n    this.handleKeyUp = this.handleKeyUp.bind(this);\n\n    document.addEventListener('keydown', this.handleKeyDown as Native);\n    document.addEventListener('keyup', this.handleKeyUp as Native);\n  }\n\n  onKeyDown(code: KeyCode, listener: Native) {\n    addListener(this.onKeyDownListeners, code, listener);\n  }\n\n  onKeyUp(code: KeyCode, listener: Native) {\n    addListener(this.onKeyUpListeners, code, listener);\n  }\n\n  setKeyMap(key: KeyCode, action: T) {\n    this.keymap[key] = action;\n  }\n\n  isActive(action: T) {\n    return this.actions.has(action);\n  }\n\n  getUserKey(code: KeyCode) {\n    return this.codeToKey.has(code) ? this.codeToKey.get(code) : null;\n  }\n\n  /*\n   * Helpers\n   */\n\n  setDirections(up: T, down: T, left: T, right: T) {\n    this.setArrows(up, down, left, right);\n    this.setWSAD(up, down, left, right);\n  }\n\n  setArrows(up: T, down: T, left: T, right: T) {\n    this.keymap[KeyCode.ArrowUp] = up;\n    this.keymap[KeyCode.ArrowDown] = down;\n    this.keymap[KeyCode.ArrowLeft] = left;\n    this.keymap[KeyCode.ArrowRight] = right;\n  }\n\n  setWSAD(up: T, down: T, left: T, right: T) {\n    this.keymap[KeyCode.KeyW] = up;\n    this.keymap[KeyCode.KeyS] = down;\n    this.keymap[KeyCode.KeyA] = left;\n    this.keymap[KeyCode.KeyD] = right;\n  }\n\n  /*\n   * Internals\n   */\n\n  private handleKeyDown(event: ExtendedKeyboardEvent) {\n    this.onEvent(event);\n    const action = this.getActionFor(event.code);\n\n    if (action != null) {\n      this.actions.add(action);\n    }\n\n    triggerListeners(event, this.onKeyDownListeners);\n  }\n\n  private handleKeyUp(event: ExtendedKeyboardEvent) {\n    const action = this.getActionFor(event.code);\n\n    if (action != null) {\n      this.actions.delete(action);\n    }\n\n    triggerListeners(event, this.onKeyUpListeners);\n  }\n\n  private getActionFor(code: KeyCode) {\n    if (!KeyCode[code]) {\n      console.log(`Missing key code: ${code}`);\n    }\n\n    return this.keymap[code];\n  }\n\n  private onEvent(event: ExtendedKeyboardEvent) {\n    this.codeToKey.set(event.code, event.key);\n  }\n}\n\nfunction addListener(\n  list: Map<KeyCode, Native[]>,\n  code: KeyCode,\n  listener: Native,\n) {\n  if (list.has(code)) {\n    list.get(code)!.push(listener);\n  } else {\n    list.set(code, [listener]);\n  }\n}\n\nfunction triggerListeners(\n  event: ExtendedKeyboardEvent,\n  list: Map<KeyCode, Native[]>,\n) {\n  const listeners = list.get(event.code);\n\n  if (listeners) {\n    listeners.forEach(x => x(event));\n  }\n}\n","export enum KeyCode {\n  // Control\n  AltLeft = 'AltLeft',\n  AltRight = 'AltRight',\n  Backslash = 'Backslash',\n  Backspace = 'Backspace',\n  CapsLock = 'CapsLock',\n  ControlLeft = 'ControlLeft',\n  Enter = 'Enter',\n  Escape = 'Escape',\n  MetaLeft = 'MetaLeft',\n  MetaRight = 'MetaRight',\n  ShiftLeft = 'ShiftLeft',\n  ShiftRight = 'ShiftRight',\n  Tab = 'Tab',\n\n  // Arrows\n  ArrowDown = 'ArrowDown',\n  ArrowLeft = 'ArrowLeft',\n  ArrowRight = 'ArrowRight',\n  ArrowUp = 'ArrowUp',\n\n  // Special chars\n  Backquote = 'Backquote',\n  BracketLeft = 'BracketLeft',\n  BracketRight = 'BracketRight',\n  Comma = 'Comma',\n  Equal = 'Equal',\n  IntlBackslash = 'IntlBackslash',\n  Minus = 'Minus',\n  Period = 'Period',\n  Quote = 'Quote',\n  Semicolon = 'Semicolon',\n  Slash = 'Slash',\n  Space = 'Space',\n\n  // Function\n  F1 = 'F1',\n  F2 = 'F2',\n  F3 = 'F3',\n  F4 = 'F4',\n  F5 = 'F5',\n  F6 = 'F6',\n  F7 = 'F7',\n  F8 = 'F8',\n\n  // Digits\n  Digit0 = 'Digit0',\n  Digit1 = 'Digit1',\n  Digit2 = 'Digit2',\n  Digit3 = 'Digit3',\n  Digit4 = 'Digit4',\n  Digit5 = 'Digit5',\n  Digit6 = 'Digit6',\n  Digit7 = 'Digit7',\n  Digit8 = 'Digit8',\n  Digit9 = 'Digit9',\n\n  // Keys\n  KeyA = 'KeyA',\n  KeyB = 'KeyB',\n  KeyC = 'KeyC',\n  KeyD = 'KeyD',\n  KeyE = 'KeyE',\n  KeyF = 'KeyF',\n  KeyG = 'KeyG',\n  KeyH = 'KeyH',\n  KeyI = 'KeyI',\n  KeyJ = 'KeyJ',\n  KeyK = 'KeyK',\n  KeyL = 'KeyL',\n  KeyM = 'KeyM',\n  KeyN = 'KeyN',\n  KeyO = 'KeyO',\n  KeyP = 'KeyP',\n  KeyQ = 'KeyQ',\n  KeyR = 'KeyR',\n  KeyS = 'KeyS',\n  KeyT = 'KeyT',\n  KeyU = 'KeyU',\n  KeyV = 'KeyV',\n  KeyW = 'KeyW',\n  KeyX = 'KeyX',\n  KeyY = 'KeyY',\n  KeyZ = 'KeyZ',\n}\n","import { PeerConnection } from '@amatiasq/peer-connection';\n\nimport {\n  ClientMessage,\n  ClientMessageType,\n} from '../../shared/communication/ClientMessage';\nimport { ClientToClientMessageType } from '../../shared/communication/ClientToClientMessage';\nimport { captureAudio, playAudio } from './audio';\nimport { User } from './User';\nimport { refreshUserList } from './users';\n\nexport class PeerChannel {\n  private readonly conn = this.createRtc();\n\n  constructor(\n    public readonly user: User,\n    private readonly send: (message: ClientMessage) => void,\n  ) {}\n\n  async sendOffer() {\n    // this.createDataChannel();\n    const offer = await this.conn.createOffer({ offerToReceiveAudio: true });\n\n    await this.send({\n      type: ClientMessageType.SEND_TO_USER,\n      to: this.user.id,\n      message: {\n        type: ClientToClientMessageType.RPC_OFFER,\n        offer,\n      },\n    });\n  }\n\n  async acceptOffer(offer: RTCSessionDescription) {\n    const stream = await captureAudio();\n    this.conn.addStream(stream);\n\n    const answer = await this.conn.acceptOffer(offer, {\n      offerToReceiveAudio: true,\n    });\n\n    await this.send({\n      type: ClientMessageType.SEND_TO_USER,\n      to: this.user.id,\n      message: {\n        type: ClientToClientMessageType.RPC_ANSWER,\n        answer,\n      },\n    });\n  }\n\n  acceptAnswer(answer: RTCSessionDescription) {\n    return this.conn.acceptAnswer(answer);\n  }\n\n  addTrack(track: MediaStreamTrack, stream: MediaStream) {\n    console.log(`Enviando audio a ${this.user.name}.`);\n    return this.conn.addTrack(track, stream);\n  }\n\n  end() {\n    this.conn.close();\n  }\n\n  private createRtc() {\n    const conn = new PeerConnection();\n\n    conn.onTrackReceived(e => {\n      console.log(`Recibiendo audio de ${this.user.name}.`);\n      playAudio(e.streams[0]);\n      refreshUserList();\n    });\n\n    return conn;\n  }\n}\n","/// <reference path=\"./freeice.d.ts\" />\nimport freeice from 'freeice';\n\nimport { emitter } from '@amatiasq/emitter';\n\nexport class PeerConnection {\n  private rtc = this.createRtc();\n  readonly onTrackReceived = emitter<RTCTrackEvent>();\n  readonly onDataChannel = emitter<RTCDataChannelEvent>();\n\n  async createOffer(options: RTCOfferOptions = {}) {\n    const offer = await this.rtc.createOffer(options);\n    await this.rtc.setLocalDescription(offer);\n    await this.processIceCandidates();\n    return this.rtc.localDescription!;\n  }\n\n  async acceptOffer(\n    offer: RTCSessionDescription,\n    options: RTCOfferOptions = {},\n  ) {\n    await this.setRemoteDescription(offer);\n    return this.createAnswer(options);\n  }\n\n  acceptAnswer(answer: RTCSessionDescription) {\n    return this.setRemoteDescription(answer);\n  }\n\n  addStream(stream: MediaStream) {\n    stream.getTracks().forEach(x => this.addTrack(x, stream));\n  }\n\n  addTrack(track: MediaStreamTrack, stream: MediaStream) {\n    return this.rtc.addTrack(track, stream);\n  }\n\n  reset() {\n    this.rtc.close();\n    this.rtc = this.createRtc();\n  }\n\n  close() {\n    this.rtc.close();\n  }\n\n  private async createAnswer(options: RTCOfferOptions = {}) {\n    const answer = await this.rtc.createAnswer(options);\n    await this.rtc.setLocalDescription(answer);\n    await this.processIceCandidates();\n    return this.rtc.localDescription!;\n  }\n\n  private createRtc() {\n    const conn = new RTCPeerConnection({ iceServers: freeice() });\n    conn.ontrack = e => this.onTrackReceived.emit(e);\n    conn.ondatachannel = e => this.onDataChannel.emit(e);\n    return conn;\n  }\n\n  private processIceCandidates() {\n    return new Promise<void>(resolve => {\n      this.rtc.onicecandidate = ({ candidate }) =>\n        candidate == null && resolve();\n    });\n  }\n\n  private setRemoteDescription(desc: RTCSessionDescription) {\n    return this.rtc.setRemoteDescription(new RTCSessionDescription(desc));\n  }\n}\n","/* jshint node: true */\n'use strict';\n\nvar normalice = require('normalice');\n\n/**\n  # freeice\n\n  The `freeice` module is a simple way of getting random STUN or TURN server\n  for your WebRTC application.  The list of servers (just STUN at this stage)\n  were sourced from this [gist](https://gist.github.com/zziuni/3741933).\n\n  ## Example Use\n\n  The following demonstrates how you can use `freeice` with\n  [rtc-quickconnect](https://github.com/rtc-io/rtc-quickconnect):\n\n  <<< examples/quickconnect.js\n\n  As the `freeice` module generates ice servers in a list compliant with the\n  WebRTC spec you will be able to use it with raw `RTCPeerConnection`\n  constructors and other WebRTC libraries.\n\n  ## Hey, don't use my STUN/TURN server!\n\n  If for some reason your free STUN or TURN server ends up in the\n  list of servers ([stun](https://github.com/DamonOehlman/freeice/blob/master/stun.json) or\n  [turn](https://github.com/DamonOehlman/freeice/blob/master/turn.json))\n  that is used in this module, you can feel\n  free to open an issue on this repository and those servers will be removed\n  within 24 hours (or sooner).  This is the quickest and probably the most\n  polite way to have something removed (and provides us some visibility\n  if someone opens a pull request requesting that a server is added).\n\n  ## Please add my server!\n\n  If you have a server that you wish to add to the list, that's awesome! I'm\n  sure I speak on behalf of a whole pile of WebRTC developers who say thanks.\n  To get it into the list, feel free to either open a pull request or if you\n  find that process a bit daunting then just create an issue requesting\n  the addition of the server (make sure you provide all the details, and if\n  you have a Terms of Service then including that in the PR/issue would be\n  awesome).\n\n  ## I know of a free server, can I add it?\n\n  Sure, if you do your homework and make sure it is ok to use (I'm currently\n  in the process of reviewing the terms of those STUN servers included from\n  the original list).  If it's ok to go, then please see the previous entry\n  for how to add it.\n\n  ## Current List of Servers\n\n  * current as at the time of last `README.md` file generation\n\n  ### STUN\n\n  <<< stun.json\n\n  ### TURN\n\n  <<< turn.json\n\n**/\n\nvar freeice = function(opts) {\n  // if a list of servers has been provided, then use it instead of defaults\n  var servers = {\n    stun: (opts || {}).stun || require('./stun.json'),\n    turn: (opts || {}).turn || require('./turn.json')\n  };\n\n  var stunCount = (opts || {}).stunCount || 2;\n  var turnCount = (opts || {}).turnCount || 0;\n  var selected;\n\n  function getServers(type, count) {\n    var out = [];\n    var input = [].concat(servers[type]);\n    var idx;\n\n    while (input.length && out.length < count) {\n      idx = (Math.random() * input.length) | 0;\n      out = out.concat(input.splice(idx, 1));\n    }\n\n    return out.map(function(url) {\n        //If it's a not a string, don't try to \"normalice\" it otherwise using type:url will screw it up\n        if ((typeof url !== 'string') && (! (url instanceof String))) {\n            return url;\n        } else {\n            return normalice(type + ':' + url);\n        }\n    });\n  }\n\n  // add stun servers\n  selected = [].concat(getServers('stun', stunCount));\n\n  if (turnCount) {\n    selected = selected.concat(getServers('turn', turnCount));\n  }\n\n  return selected;\n};\n\nmodule.exports = freeice;","/**\n  # normalice\n\n  Normalize an ice server configuration object (or plain old string) into a format\n  that is usable in all browsers supporting WebRTC.  Primarily this module is designed\n  to help with the transition of the `url` attribute of the configuration object to\n  the `urls` attribute.\n\n  ## Example Usage\n\n  <<< examples/simple.js\n\n**/\n\nvar protocols = [\n  'stun:',\n  'turn:'\n];\n\nmodule.exports = function(input) {\n  var url = (input || {}).url || input;\n  var protocol;\n  var parts;\n  var output = {};\n\n  // if we don't have a string url, then allow the input to passthrough\n  if (typeof url != 'string' && (! (url instanceof String))) {\n    return input;\n  }\n\n  // trim the url string, and convert to an array\n  url = url.trim();\n\n  // if the protocol is not known, then passthrough\n  protocol = protocols[protocols.indexOf(url.slice(0, 5))];\n  if (! protocol) {\n    return input;\n  }\n\n  // now let's attack the remaining url parts\n  url = url.slice(5);\n  parts = url.split('@');\n\n  output.username = input.username;\n  output.credential = input.credential;\n  // if we have an authentication part, then set the credentials\n  if (parts.length > 1) {\n    url = parts[1];\n    parts = parts[0].split(':');\n\n    // add the output credential and username\n    output.username = parts[0];\n    output.credential = (input || {}).credential || parts[1] || '';\n  }\n\n  output.url = protocol + url;\n  output.urls = [ output.url ];\n\n  return output;\n};\n","import {\n  ServerMessage,\n  ServerMessageType,\n} from './../../shared/communication/ServerMessage';\nimport { JsonSocket } from '@amatiasq/json-socket';\nimport { ClientMessage } from '../../shared/communication/ClientMessage';\n\nexport class Socket {\n  private readonly socket = new JsonSocket<ServerMessage, ClientMessage>(\n    this.uri,\n  );\n  private readonly listeners = new Map<ServerMessageType, Listener[]>();\n\n  constructor(public readonly uri: string) {\n    this.socket.onMessage(e => this.processMessage(e));\n  }\n\n  onMessage<T extends ServerMessageType>(\n    type: T,\n    listener: (message: TypedMessage<T>) => void,\n  ) {\n    if (this.listeners.has(type)) {\n      this.listeners.get(type)!.push(listener as any);\n    } else {\n      this.listeners.set(type, [listener as any]);\n    }\n  }\n\n  send(value: ClientMessage) {\n    this.socket.send(value);\n  }\n\n  private processMessage(message: ServerMessage): void {\n    const listeners = this.listeners.get(message.type);\n\n    console.debug(message.type, message);\n\n    if (listeners) {\n      listeners.forEach(x => x(message));\n    } else {\n      console.log(`Unhandled message: ${message.type}`);\n    }\n  }\n}\n\ntype Listener = (message: ServerMessage) => void;\n\ntype TypedMessage<T extends ServerMessageType> = Extract<\n  ServerMessage,\n  { type: T }\n>;\n","import { emitter } from '@amatiasq/emitter';\n\nconst DEFAULT_RECONNECTION_DELAY = 100;\nconst MAX_RECONNECT_ATTEMPTS = 14;\n\nexport class JsonSocket<TInput, TOutput> {\n  RECONNECTION_DELAY = DEFAULT_RECONNECTION_DELAY;\n  MAX_RECONNECT_ATTEMPTS = MAX_RECONNECT_ATTEMPTS;\n\n  private reconnectionDelay = DEFAULT_RECONNECTION_DELAY;\n  private reconnectAttempts = 0;\n  private disconnectedAt = new Date();\n  private isReconnecting = false;\n  private isFirstConnection = true;\n\n  private ws = this.init();\n\n  readonly onOpen = emitter<JsonSocket<TInput, TOutput>>();\n  readonly onMessage = emitter<TInput>();\n  readonly onReconnect = emitter<Date>();\n\n  get isConnected() {\n    return !this.isFirstConnection && !this.isReconnecting;\n  }\n\n  constructor(public readonly uri: string) {}\n\n  private init() {\n    const socket = new WebSocket(this.uri);\n\n    socket.onopen = () => this.connectionOpen();\n    socket.onmessage = e => this.processMessage(e);\n    socket.onerror = () => this.connectionLost();\n    socket.onclose = () => this.connectionLost();\n\n    return socket;\n  }\n\n  send(value: TOutput) {\n    this.ws.send(JSON.stringify(value));\n  }\n\n  private processMessage(event: MessageEvent<any>) {\n    let message: TInput;\n\n    try {\n      message = JSON.parse(event.data) as TInput;\n    } catch (error) {\n      console.error('Invalid JSON', event.data);\n      return;\n    }\n\n    this.onMessage.emit(message);\n  }\n\n  private connectionOpen() {\n    this.reconnectionDelay = this.RECONNECTION_DELAY;\n    this.reconnectAttempts = 0;\n    this.isReconnecting = false;\n\n    if (this.isFirstConnection) {\n      this.isFirstConnection = false;\n      this.onOpen.emit(this);\n    } else {\n      this.onReconnect.emit(this.disconnectedAt);\n    }\n  }\n\n  private connectionLost() {\n    if (this.isReconnecting) {\n      return;\n    }\n\n    if (this.reconnectAttempts > this.MAX_RECONNECT_ATTEMPTS) {\n      return console.error(\n        `Websocket aborted after ${this.reconnectAttempts} attempts`,\n      );\n    }\n\n    if (this.reconnectAttempts === 0) {\n      this.isReconnecting = true;\n      this.disconnectedAt = new Date();\n    }\n\n    const message = `Socket closed. Waiting ${this.reconnectionDelay / 1000}s`;\n    const reconnecting = 'Reconnecting...';\n    const singleLine = this.reconnectAttempts < 1000;\n\n    console.debug(`${message} ${singleLine ? reconnecting : ''}`);\n\n    setTimeout(() => {\n      if (!singleLine) {\n        console.debug(reconnecting);\n      }\n\n      this.reconnectionDelay *= 2;\n      this.reconnectAttempts++;\n      this.ws = this.init();\n    }, this.reconnectionDelay);\n  }\n\n  close() {\n    this.ws.onclose = null;\n    this.ws.close();\n  }\n}\n"],"sourceRoot":""}