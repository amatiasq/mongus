!function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(1),i=n(2),s=n(3),r=n(4),c=n(5),a=n(7),y=new r.Socket("wss://amongus.amatiasq.com"),d=`${Math.random()}${Date.now()}${Math.random()}©AMONGUS®`;let h=[];function u(){console.log("users",h)}a.watchKeyboard(e=>y.send({type:o.ClientMessageType.USER_ACTIONS,actions:Array.from(e)})),requestAnimationFrame((function e(){s.render(h),requestAnimationFrame(e)})),y.onOpen(()=>y.send({type:o.ClientMessageType.LOGIN,uuid:d})),y.onReconnect(()=>y.send({type:o.ClientMessageType.RECONNECT,uuid:d})),y.onMessageType(i.ServerMessageType.LOGIN_SUCCESS,e=>{h=e.users.map(e=>new c.User(e,e.id===d)),u()}),y.onMessageType(i.ServerMessageType.USER_CONNECTED,e=>{h.push(new c.User(e.user)),u()}),y.onMessageType(i.ServerMessageType.USER_DISCONNECTED,e=>{const t=h.findIndex(t=>t.id===e.uuid);-1!==t&&(h.splice(t,1),u())}),y.onMessageType(i.ServerMessageType.GAME_STEP,e=>{h=e.users.map(e=>new c.User(e,e.id===d))}),window.onbeforeunload=()=>{y.send({type:o.ClientMessageType.LOGOUT})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientMessageType=void 0,function(e){e.ERROR="ERROR",e.LOGIN="LOGIN",e.LOGOUT="LOGOUT",e.RECONNECT="RECONNECT",e[e.USER_ACTIONS=1]="USER_ACTIONS"}(t.ClientMessageType||(t.ClientMessageType={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerMessageType=void 0,function(e){e.ERROR="ERROR",e.HANDSHAKE="HANDSHAKE",e.LOGIN_SUCCESS="LOGIN_SUCCESS",e.USER_CONNECTED="USER_CONNECTED",e.USER_DISCONNECTED="USER_DISCONNECTED",e.MESSAGE_FROM_USER="MESSAGE_FROM_USER",e.MESSAGE_TO_ROOM="MESSAGE_TO_ROOM",e[e.GAME_STEP=1]="GAME_STEP"}(t.ServerMessageType||(t.ServerMessageType={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.render=void 0;const o=document.querySelector("canvas"),i=o.getContext("2d"),s=new Image;function r(){o.width=window.innerWidth,o.height=window.innerHeight}s.src="assets/sprites/player.png",r(),window.onresize=r,t.render=function(e){i.clearRect(0,0,o.width,o.height),e.map(e=>{i.fillStyle=e.isPlayer?"green":"red",i.textAlign="center",i.fillText(e.id,e.position.x,e.position.y-15-s.height/2),i.drawImage(s,e.position.x-s.width/2,e.position.y-s.height/2)})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=void 0;const o=n(11);class i extends o.JsonSocket{constructor(e){super(e),this.listeners=new Map,this.onMessage(e=>this.processMessagePotato(e))}onMessageType(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}processMessagePotato(e){const t=this.listeners.get(e.type);console.debug(e.type,e),t?t.forEach(t=>t(e)):console.log("Unhandled message: "+e.type)}}t.Socket=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.User=void 0;const o=n(6);t.User=class{constructor({id:e,position:t},n=!1){this.isPlayer=n,this.position={x:0,y:0},this.id=e,this.position=t}toJSON(){return o.serializeUser(this)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serializeUser=void 0,t.serializeUser=function({id:e,position:t}){return{id:e,position:t}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.watchKeyboard=void 0;const o=n(8),i=n(10),s=new o.KeyboardController,r=new Set,c={[o.KeyCode.KeyW]:i.Action.UP,[o.KeyCode.KeyS]:i.Action.DOWN,[o.KeyCode.KeyA]:i.Action.LEFT,[o.KeyCode.KeyD]:i.Action.RIGHT,[o.KeyCode.ArrowUp]:i.Action.UP,[o.KeyCode.ArrowDown]:i.Action.DOWN,[o.KeyCode.ArrowLeft]:i.Action.LEFT,[o.KeyCode.ArrowRight]:i.Action.RIGHT};t.watchKeyboard=function(e){Object.entries(c).map(([t,n])=>{s.onKeyDown(t,()=>{r.has(n)||(r.add(n),e(Array.from(r)))}),s.onKeyUp(t,()=>{r.has(n)&&(r.delete(n),e(Array.from(r)))})})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyboardController=t.KeyCode=void 0;const o=n(9);Object.defineProperty(t,"KeyCode",{enumerable:!0,get:function(){return o.KeyCode}});function i(e,t,n){e.has(t)?e.get(t).push(n):e.set(t,[n])}function s(e,t){const n=t.get(e.code);n&&n.forEach(t=>t(e))}t.KeyboardController=class{constructor(){this.keymap={},this.actions=new Set,this.codeToKey=new Map,this.onKeyDownListeners=new Map,this.onKeyUpListeners=new Map,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}onKeyDown(e,t){i(this.onKeyDownListeners,e,t)}onKeyUp(e,t){i(this.onKeyUpListeners,e,t)}setKeyMap(e,t){this.keymap[e]=t}isActive(e){return this.actions.has(e)}getUserKey(e){return this.codeToKey.has(e)?this.codeToKey.get(e):null}setDirections(e,t,n,o){this.setArrows(e,t,n,o),this.setWSAD(e,t,n,o)}setArrows(e,t,n,i){this.keymap[o.KeyCode.ArrowUp]=e,this.keymap[o.KeyCode.ArrowDown]=t,this.keymap[o.KeyCode.ArrowLeft]=n,this.keymap[o.KeyCode.ArrowRight]=i}setWSAD(e,t,n,i){this.keymap[o.KeyCode.KeyW]=e,this.keymap[o.KeyCode.KeyS]=t,this.keymap[o.KeyCode.KeyA]=n,this.keymap[o.KeyCode.KeyD]=i}handleKeyDown(e){this.onEvent(e);const t=this.getActionFor(e.code);null!=t&&this.actions.add(t),s(e,this.onKeyDownListeners)}handleKeyUp(e){const t=this.getActionFor(e.code);null!=t&&this.actions.delete(t),s(e,this.onKeyUpListeners)}getActionFor(e){return o.KeyCode[e]||console.log("Missing key code: "+e),this.keymap[e]}onEvent(e){this.codeToKey.set(e.code,e.key)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyCode=void 0,function(e){e.AltLeft="AltLeft",e.AltRight="AltRight",e.Backslash="Backslash",e.Backspace="Backspace",e.CapsLock="CapsLock",e.ControlLeft="ControlLeft",e.Enter="Enter",e.Escape="Escape",e.MetaLeft="MetaLeft",e.MetaRight="MetaRight",e.ShiftLeft="ShiftLeft",e.ShiftRight="ShiftRight",e.Tab="Tab",e.ArrowDown="ArrowDown",e.ArrowLeft="ArrowLeft",e.ArrowRight="ArrowRight",e.ArrowUp="ArrowUp",e.Backquote="Backquote",e.BracketLeft="BracketLeft",e.BracketRight="BracketRight",e.Comma="Comma",e.Equal="Equal",e.IntlBackslash="IntlBackslash",e.Minus="Minus",e.Period="Period",e.Quote="Quote",e.Semicolon="Semicolon",e.Slash="Slash",e.Space="Space",e.F1="F1",e.F2="F2",e.F3="F3",e.F4="F4",e.F5="F5",e.F6="F6",e.F7="F7",e.F8="F8",e.Digit0="Digit0",e.Digit1="Digit1",e.Digit2="Digit2",e.Digit3="Digit3",e.Digit4="Digit4",e.Digit5="Digit5",e.Digit6="Digit6",e.Digit7="Digit7",e.Digit8="Digit8",e.Digit9="Digit9",e.KeyA="KeyA",e.KeyB="KeyB",e.KeyC="KeyC",e.KeyD="KeyD",e.KeyE="KeyE",e.KeyF="KeyF",e.KeyG="KeyG",e.KeyH="KeyH",e.KeyI="KeyI",e.KeyJ="KeyJ",e.KeyK="KeyK",e.KeyL="KeyL",e.KeyM="KeyM",e.KeyN="KeyN",e.KeyO="KeyO",e.KeyP="KeyP",e.KeyQ="KeyQ",e.KeyR="KeyR",e.KeyS="KeyS",e.KeyT="KeyT",e.KeyU="KeyU",e.KeyV="KeyV",e.KeyW="KeyW",e.KeyX="KeyX",e.KeyY="KeyY",e.KeyZ="KeyZ"}(t.KeyCode||(t.KeyCode={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Action=void 0,function(e){e[e.UP=0]="UP",e[e.DOWN=1]="DOWN",e[e.LEFT=2]="LEFT",e[e.RIGHT=3]="RIGHT"}(t.Action||(t.Action={}))},function(e,t,n){"use strict";function o(){const e=new Set;return t.emit=function(t){e.forEach(e=>e(t))},t;function t(t){return e.add(t),()=>e.delete(t)}}n.r(t),n.d(t,"JsonSocket",(function(){return i}));class i{constructor(e){this.uri=e,this.RECONNECTION_DELAY=100,this.MAX_RECONNECT_ATTEMPTS=14,this.reconnectionDelay=100,this.reconnectAttempts=0,this.disconnectedAt=new Date,this.isReconnecting=!1,this.isFirstConnection=!0,this.ws=this.init(),this.onOpen=o(),this.onMessage=o(),this.onReconnect=o()}get isConnected(){return!this.isFirstConnection&&!this.isReconnecting}init(){const e=new WebSocket(this.uri);return e.onopen=()=>this.connectionOpen(),e.onmessage=e=>this.processMessage(e),e.onerror=()=>this.connectionLost(),e.onclose=()=>this.connectionLost(),e}send(e){this.ws.send(JSON.stringify(e))}processMessage(e){let t;try{t=JSON.parse(e.data)}catch(t){return void console.error("Invalid JSON",e.data)}this.onMessage.emit(t)}connectionOpen(){this.reconnectionDelay=this.RECONNECTION_DELAY,this.reconnectAttempts=0,this.isReconnecting=!1,this.isFirstConnection?(this.isFirstConnection=!1,this.onOpen.emit(this)):this.onReconnect.emit(this.disconnectedAt)}connectionLost(){if(this.isReconnecting)return;if(this.reconnectAttempts>this.MAX_RECONNECT_ATTEMPTS)return console.error(`Websocket aborted after ${this.reconnectAttempts} attempts`);0===this.reconnectAttempts&&(this.isReconnecting=!0,this.disconnectedAt=new Date);const e=`Socket closed. Waiting ${this.reconnectionDelay/1e3}s`,t="Reconnecting...",n=this.reconnectAttempts<1e3;console.debug(`${e} ${n?t:""}`),setTimeout(()=>{n||console.debug(t),this.reconnectionDelay*=2,this.reconnectAttempts++,this.ws=this.init()},this.reconnectionDelay)}close(){this.ws.onclose=null,this.ws.close()}}}]);
//# sourceMappingURL=main.js.map