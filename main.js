!function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(1),n=s(2),o=s(3),r=s(4),c=s(5),a=s(7),h=new r.Socket("wss://amongus.amatiasq.com"),d=`${Math.random()}${Date.now()}${Math.random()}©AMONGUS®`;let y=[];function u(){console.log("users",y)}a.watchKeyboard(e=>h.send({type:i.ClientMessageType.USER_ACTIONS,actions:Array.from(e)})),requestAnimationFrame((function e(){o.render(y),requestAnimationFrame(e)})),h.onOpen(()=>h.send({type:i.ClientMessageType.LOGIN,uuid:d})),h.onReconnect(()=>h.send({type:i.ClientMessageType.RECONNECT,uuid:d})),h.onMessageType(n.ServerMessageType.LOGIN_SUCCESS,e=>{y=e.users.map(e=>new c.User(e,e.id===d)),u()}),h.onMessageType(n.ServerMessageType.USER_CONNECTED,e=>{y.push(new c.User(e.user)),u()}),h.onMessageType(n.ServerMessageType.USER_DISCONNECTED,e=>{const t=y.findIndex(t=>t.id===e.uuid);-1!==t&&(y.splice(t,1),u())}),h.onMessageType(n.ServerMessageType.GAME_STEP,e=>{y=e.users.map(e=>new c.User(e,e.id===d))}),window.onbeforeunload=()=>{h.send({type:i.ClientMessageType.LOGOUT})}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientMessageType=void 0,function(e){e.ERROR="ERROR",e.LOGIN="LOGIN",e.LOGOUT="LOGOUT",e.RECONNECT="RECONNECT",e[e.USER_ACTIONS=1]="USER_ACTIONS"}(t.ClientMessageType||(t.ClientMessageType={}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerMessageType=void 0,function(e){e.ERROR="ERROR",e.HANDSHAKE="HANDSHAKE",e.LOGIN_SUCCESS="LOGIN_SUCCESS",e.USER_CONNECTED="USER_CONNECTED",e.USER_DISCONNECTED="USER_DISCONNECTED",e.MESSAGE_FROM_USER="MESSAGE_FROM_USER",e.MESSAGE_TO_ROOM="MESSAGE_TO_ROOM",e[e.GAME_STEP=1]="GAME_STEP"}(t.ServerMessageType||(t.ServerMessageType={}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.render=void 0;const i=document.querySelector("canvas"),n=i.getContext("2d"),o=new Image;function r(){i.width=window.innerWidth,i.height=window.innerHeight}o.src="assets/sprites/player.png",r(),window.onresize=r,t.render=function(e){n.clearRect(0,0,i.width,i.height),e.map(e=>{n.fillStyle=e.isPlayer?"green":"red",n.textAlign="center",n.fillText(e.id,e.position.x,e.position.y-15-o.height/2),n.drawImage(o,e.position.x-o.width/2,e.position.y-o.height/2)})}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=void 0;const i=s(10);class n extends i.JsonSocket{constructor(e){super(e),this.listeners=new Map,this.onMessage(e=>this.processMessagePotato(e))}onMessageType(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}processMessagePotato(e){const t=this.listeners.get(e.type);console.debug(e.type,e),t?t.forEach(t=>t(e)):console.log("Unhandled message: "+e.type)}}t.Socket=n},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.User=void 0;const i=s(6);t.User=class{constructor({id:e,position:t},s=!1){this.isPlayer=s,this.position={x:0,y:0},this.id=e,this.position=t}toJSON(){return i.serializeUser(this)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serializeUser=void 0,t.serializeUser=function({id:e,position:t}){return{id:e,position:t}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.watchKeyboard=void 0;const i=s(9),n=s(8),o=new i.KeyboardActions;o.setDirections(n.Action.UP,n.Action.DOWN,n.Action.LEFT,n.Action.RIGHT),t.watchKeyboard=function(e){o.onChange(t=>e(t))}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Action=void 0,function(e){e[e.UP=0]="UP",e[e.DOWN=1]="DOWN",e[e.LEFT=2]="LEFT",e[e.RIGHT=3]="RIGHT"}(t.Action||(t.Action={}))},function(e,t,s){"use strict";function i(){const e=new Map;return t.subscribe=function(t,s){const i=e.get(t)||new Set;s.length||e.set(t,i);return i.add(s),()=>i.delete(s)},t;function t(t,s){const i=e.get(t);i&&i.forEach(e=>e(s))}}function n(){const e=new Set;return t.subscribe=function(t){return e.add(t),()=>e.delete(t)},t;function t(t){e.forEach(e=>e(t))}}s.r(t),s.d(t,"KeyboardActions",(function(){return c})),s.d(t,"KeyboardController",(function(){return o})),s.d(t,"KeyCode",(function(){return r}));class o{constructor(){this.pressed=new Set,this.codeToKey=new Map,this.emitKeyCodeDown=i(),this.emitKeyCodeUp=i(),this.emitKeyDown=n(),this.emitKeyUp=n(),this.onKeyCodeDown=this.emitKeyCodeDown.subscribe,this.onKeyCodeUp=this.emitKeyCodeUp.subscribe,this.onKeyDown=this.emitKeyDown.subscribe,this.onKeyUp=this.emitKeyUp.subscribe,this.isPaused=!1,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}pause(){this.isPaused=!0}resume(){this.isPaused=!1}isPressed(e){return this.pressed.has(e)}getUserKey(e){return this.codeToKey.has(e)?this.codeToKey.get(e):null}dispose(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){this.onEvent(e),this.isPressed(e.code)||(this.pressed.add(e.code),this.isPaused||(this.emitKeyDown(e),this.emitKeyCodeDown(e.code,e)))}handleKeyUp(e){this.onEvent(e),this.isPressed(e.code)&&(this.pressed.delete(e.code),this.isPaused||(this.emitKeyUp(e),this.emitKeyCodeUp(e.code,e)))}onEvent(e){this.codeToKey.set(e.code,e.key)}}var r;!function(e){e.AltLeft="AltLeft",e.AltRight="AltRight",e.Backslash="Backslash",e.Backspace="Backspace",e.CapsLock="CapsLock",e.ControlLeft="ControlLeft",e.Enter="Enter",e.Escape="Escape",e.MetaLeft="MetaLeft",e.MetaRight="MetaRight",e.ShiftLeft="ShiftLeft",e.ShiftRight="ShiftRight",e.Tab="Tab",e.ArrowDown="ArrowDown",e.ArrowLeft="ArrowLeft",e.ArrowRight="ArrowRight",e.ArrowUp="ArrowUp",e.Backquote="Backquote",e.BracketLeft="BracketLeft",e.BracketRight="BracketRight",e.Comma="Comma",e.Equal="Equal",e.IntlBackslash="IntlBackslash",e.Minus="Minus",e.Period="Period",e.Quote="Quote",e.Semicolon="Semicolon",e.Slash="Slash",e.Space="Space",e.F1="F1",e.F2="F2",e.F3="F3",e.F4="F4",e.F5="F5",e.F6="F6",e.F7="F7",e.F8="F8",e.Digit0="Digit0",e.Digit1="Digit1",e.Digit2="Digit2",e.Digit3="Digit3",e.Digit4="Digit4",e.Digit5="Digit5",e.Digit6="Digit6",e.Digit7="Digit7",e.Digit8="Digit8",e.Digit9="Digit9",e.KeyA="KeyA",e.KeyB="KeyB",e.KeyC="KeyC",e.KeyD="KeyD",e.KeyE="KeyE",e.KeyF="KeyF",e.KeyG="KeyG",e.KeyH="KeyH",e.KeyI="KeyI",e.KeyJ="KeyJ",e.KeyK="KeyK",e.KeyL="KeyL",e.KeyM="KeyM",e.KeyN="KeyN",e.KeyO="KeyO",e.KeyP="KeyP",e.KeyQ="KeyQ",e.KeyR="KeyR",e.KeyS="KeyS",e.KeyT="KeyT",e.KeyU="KeyU",e.KeyV="KeyV",e.KeyW="KeyW",e.KeyX="KeyX",e.KeyY="KeyY",e.KeyZ="KeyZ"}(r||(r={}));class c{constructor(){this.keyboard=new o,this.keymap={},this.actions=new Set,this.emitChange=n(),this.emitActivate=i(),this.emitDeactivate=i(),this.onChange=this.emitChange.subscribe,this.onActivate=this.emitActivate.subscribe,this.onDeactivate=this.emitDeactivate.subscribe,this.handleKeyDown=this.handle(e=>{this.actions.has(e)||(this.actions.add(e),this.emitActivate(e),this.emitChange(Array.from(this.actions)))}),this.handleKeyUp=this.handle(e=>{this.actions.has(e)&&(this.actions.delete(e),this.emitDeactivate(e),this.emitChange(Array.from(this.actions)))}),this.subscriptions=[this.keyboard.onKeyDown(this.handleKeyDown),this.keyboard.onKeyUp(this.handleKeyUp)]}get isPaused(){return this.keyboard.isPaused}pause(){this.keyboard.pause()}resume(){this.keyboard.resume()}getUserKey(e){this.keyboard.getUserKey(e)}setKeyMap(e,t){this.keymap[e]=t}isActive(e){return this.actions.has(e)}dispose(){this.subscriptions.forEach(e=>e()),this.keyboard.dispose()}setDirections(e,t,s,i){this.setArrows(e,t,s,i),this.setWSAD(e,t,s,i)}setArrows(e,t,s,i){this.keymap[r.ArrowUp]=e,this.keymap[r.ArrowDown]=t,this.keymap[r.ArrowLeft]=s,this.keymap[r.ArrowRight]=i}setWSAD(e,t,s,i){this.keymap[r.KeyW]=e,this.keymap[r.KeyS]=t,this.keymap[r.KeyA]=s,this.keymap[r.KeyD]=i}getActionFor(e){return r[e]||console.log("Missing key code: "+e),this.keymap[e]}handle(e){return t=>{const s=this.getActionFor(t.code);null!=s&&e(s)}}}},function(e,t,s){"use strict";function i(){const e=new Set;return t.emit=function(t){e.forEach(e=>e(t))},t;function t(t){return e.add(t),()=>e.delete(t)}}s.r(t),s.d(t,"JsonSocket",(function(){return n}));class n{constructor(e){this.uri=e,this.RECONNECTION_DELAY=100,this.MAX_RECONNECT_ATTEMPTS=14,this.reconnectionDelay=100,this.reconnectAttempts=0,this.disconnectedAt=new Date,this.isReconnecting=!1,this.isFirstConnection=!0,this.ws=this.init(),this.onOpen=i(),this.onMessage=i(),this.onReconnect=i()}get isConnected(){return!this.isFirstConnection&&!this.isReconnecting}init(){const e=new WebSocket(this.uri);return e.onopen=()=>this.connectionOpen(),e.onmessage=e=>this.processMessage(e),e.onerror=()=>this.connectionLost(),e.onclose=()=>this.connectionLost(),e}send(e){this.ws.send(JSON.stringify(e))}processMessage(e){let t;try{t=JSON.parse(e.data)}catch(t){return void console.error("Invalid JSON",e.data)}this.onMessage.emit(t)}connectionOpen(){this.reconnectionDelay=this.RECONNECTION_DELAY,this.reconnectAttempts=0,this.isReconnecting=!1,this.isFirstConnection?(this.isFirstConnection=!1,this.onOpen.emit(this)):this.onReconnect.emit(this.disconnectedAt)}connectionLost(){if(this.isReconnecting)return;if(this.reconnectAttempts>this.MAX_RECONNECT_ATTEMPTS)return console.error(`Websocket aborted after ${this.reconnectAttempts} attempts`);0===this.reconnectAttempts&&(this.isReconnecting=!0,this.disconnectedAt=new Date);const e=`Socket closed. Waiting ${this.reconnectionDelay/1e3}s`,t="Reconnecting...",s=this.reconnectAttempts<1e3;console.debug(`${e} ${s?t:""}`),setTimeout(()=>{s||console.debug(t),this.reconnectionDelay*=2,this.reconnectAttempts++,this.ws=this.init()},this.reconnectionDelay)}close(){this.ws.onclose=null,this.ws.close()}}}]);
//# sourceMappingURL=main.js.map