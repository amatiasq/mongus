!function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=1)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Color=void 0;const i=/^#([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})?$/,n=/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})?$/,o=/^rgb\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)$/,r=/^rgba\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)$/,a=255;class c{constructor(e,t,s,i=1){this.r=e,this.g=t,this.b=s,this.a=i}static fromArray([e,t,s,i]){return new c(e,t,s,null==i?1:i)}static fromHex(e){const t=function(e){const t=i.exec(e)||n.exec(e);if(!t)throw new Error("Invalid HEX color "+e);const s=t.slice(1);s[3]=s[3]||"FF";const o=s.map(e=>{const t=2===e.length?e:e+e;return parseInt(t,16)});return o[3]/=255,o}(e.trim());return this.fromArray(t)}static fromRgb(e){const t=function(e){const t=o.exec(e)||r.exec(e);if(!t)throw new Error("Invalid RGB color "+e);const[s,i,n,a]=t.slice(1);return[parseFloat(s),parseFloat(i),parseFloat(n),null==a?1:parseFloat(a)]}(e.trim());return this.fromArray(t)}static fromImageData(e,t){return new c(e[t],e[t+1],e[t+2],e[t+3])}get hex(){return function(e){const t=e.toArray();1===t[3]?t.length--:t[3]=Math.round(t[3]*a);return"#"+t.map(e=>e.toString(16)).join("")}(this)}get rgb(){return`rgba(${this.toArray().join(", ")})`}get brightness(){return(.299*(e=this).r+.587*e.g+.114*e.b)/256;var e}get isLight(){return this.brightness>.5}get isDark(){return this.brightness<=.5}get isReddish(){return h(this.r,this.g,this.b)}get isBlueish(){return h(this.b,this.r,this.g)}get isGreenish(){return h(this.g,this.r,this.b)}isLigherThan(e){return this.brightness>e.brightness}isDarkerThan(e){return this.brightness<e.brightness}isEqual(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}shade(e){return new c(...this.toArray().map(t=>t*(1-e)))}setToImageData(e,t,s=!1){e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,s||(e[t+3]=255*this.a)}toArray(){const{r:e,g:t,b:s,a:i}=this;return[e,t,s,i]}toString(){return this.rgb}}function h(e,t,s){return e>10&&e>t&&e>s}t.Color=c},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(2),n=s(3),o=s(4),r=s(6),a=s(7),c=s(9),h=new r.Socket("wss://amongus.amatiasq.com"),u=`${Math.random()}${Date.now()}${Math.random()}©AMONGUS®`;let d=[],l=[];function y(){console.log("users",d)}c.watchKeyboard(e=>h.send({type:i.ClientMessageType.USER_ACTIONS,actions:Array.from(e)})),h.onOpen(()=>h.send({type:i.ClientMessageType.LOGIN,uuid:u})),h.onReconnect(()=>h.send({type:i.ClientMessageType.RECONNECT,uuid:u})),h.onMessageType(n.ServerMessageType.LOGIN_SUCCESS,e=>{d=e.users.map(e=>new a.User(e,e.id===u)),y()}),h.onMessageType(n.ServerMessageType.USER_CONNECTED,e=>{d.push(new a.User(e.user)),y()}),h.onMessageType(n.ServerMessageType.USER_DISCONNECTED,e=>{const t=d.findIndex(t=>t.id===e.uuid);-1!==t&&(d.splice(t,1),y())}),h.onMessageType(n.ServerMessageType.GAME_STEP,e=>{d=e.users.map(e=>new a.User(e,e.id===u)),l=e.entities,o.render(d,l)}),window.onbeforeunload=()=>{h.send({type:i.ClientMessageType.LOGOUT})}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientMessageType=void 0,function(e){e.ERROR="ERROR",e.LOGIN="LOGIN",e.LOGOUT="LOGOUT",e.RECONNECT="RECONNECT",e[e.USER_ACTIONS=1]="USER_ACTIONS"}(t.ClientMessageType||(t.ClientMessageType={}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerMessageType=void 0,function(e){e.ERROR="ERROR",e.HANDSHAKE="HANDSHAKE",e.LOGIN_SUCCESS="LOGIN_SUCCESS",e.USER_CONNECTED="USER_CONNECTED",e.USER_DISCONNECTED="USER_DISCONNECTED",e.MESSAGE_FROM_USER="MESSAGE_FROM_USER",e.MESSAGE_TO_ROOM="MESSAGE_TO_ROOM",e[e.GAME_STEP=1]="GAME_STEP"}(t.ServerMessageType||(t.ServerMessageType={}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.render=void 0;const i=s(0),n=s(5),o=document.querySelector("canvas"),r=o.getContext("2d"),a=new n.PlayerSprite("assets/sprites/player.png"),c=new n.PlayerSprite("assets/sprites/phantom.png"),h=new n.PlayerSprite("assets/sprites/body.png");function u(){o.width=window.innerWidth,o.height=window.innerHeight}u(),window.onresize=u,t.render=function(e,t){r.clearRect(0,0,o.width,o.height),t.forEach(e=>{const t=h.getColor(i.Color.fromHex(e.color));r.drawImage(t,e.position.x-t.width/2,e.position.y-t.height/2)}),e.forEach(e=>{if(r.fillStyle=e.color.rgb,r.textAlign="center",r.fillText(e.id,e.position.x,e.position.y-15-a.height/2),e.isDead){const t=c.getColor(e.color);r.globalAlpha=.8,r.drawImage(t,e.position.x-t.width/2,e.position.y-t.height/2),r.globalAlpha=1}else{const t=a.getColor(e.color);r.drawImage(t,e.position.x-t.width/2,e.position.y-t.height/2)}})}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayerSprite=void 0;const i=s(0);t.PlayerSprite=class{constructor(e){this.template=new Image,this.colors=new Map,this.isReady=!1,this.template.src=e,this.template.onload=()=>this.isReady=!0}get width(){return this.template.width}get height(){return this.template.height}getColor(e){if(!this.isReady)return this.template;const t=e.rgb;if(this.colors.has(t))return this.colors.get(t);const s=this.paintTemplate(e);return this.colors.set(t,s),s}paintTemplate(e){const t=e.shade(.5),s=document.createElement("canvas"),n=s.getContext("2d"),{width:o,height:r}=this.template;s.width=o,s.height=r,n.drawImage(this.template,0,0);const a=n.getImageData(0,0,o,r),{data:c}=a;for(let s=0,n=c.length;s<n;s+=4){const n=i.Color.fromImageData(c,s);n.isReddish?e.setToImageData(c,s,!0):n.isBlueish&&t.setToImageData(c,s,!0)}return n.putImageData(a,0,0),s}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=void 0;const i=s(12);class n extends i.JsonSocket{constructor(e){super(e),this.listeners=new Map,this.onMessage(e=>this.processMessagePotato(e))}onMessageType(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}processMessagePotato(e){const t=this.listeners.get(e.type);console.debug(e.type,e),t?t.forEach(t=>t(e)):console.log("Unhandled message: "+e.type)}}t.Socket=n},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.User=void 0;const i=s(8),n=s(0);t.User=class{constructor({id:e,position:t,color:s,isDead:i},o=!1){this.isPlayer=o,this.position={x:0,y:0},this.id=e,this.position=t,this.color=n.Color.fromHex(s),this.isDead=i}toJSON(){return i.serializeUser({...this,color:this.color.hex})}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serializeUser=void 0,t.serializeUser=function({id:e,position:t,color:s,isDead:i}){return{id:e,position:t,color:s,isDead:i}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.watchKeyboard=void 0;const i=s(11),n=s(10),o=new i.KeyboardActions;o.setDirections(n.Action.UP,n.Action.DOWN,n.Action.LEFT,n.Action.RIGHT),o.setKeyMap(i.KeyCode.KeyK,n.Action.KILL),t.watchKeyboard=function(e){o.onChange(t=>e(t))}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Action=void 0,function(e){e[e.UP=0]="UP",e[e.DOWN=1]="DOWN",e[e.LEFT=2]="LEFT",e[e.RIGHT=3]="RIGHT",e[e.KILL=4]="KILL"}(t.Action||(t.Action={}))},function(e,t,s){"use strict";function i(){const e=new Map;return t.subscribe=function(t,s){const i=e.get(t)||new Set;s.length||e.set(t,i);return i.add(s),()=>i.delete(s)},t;function t(t,s){const i=e.get(t);i&&i.forEach(e=>e(s))}}function n(){const e=new Set;return t.subscribe=function(t){return e.add(t),()=>e.delete(t)},t;function t(t){e.forEach(e=>e(t))}}s.r(t),s.d(t,"KeyboardActions",(function(){return a})),s.d(t,"KeyboardController",(function(){return o})),s.d(t,"KeyCode",(function(){return r}));class o{constructor(){this.pressed=new Set,this.codeToKey=new Map,this.emitKeyCodeDown=i(),this.emitKeyCodeUp=i(),this.emitKeyDown=n(),this.emitKeyUp=n(),this.onKeyCodeDown=this.emitKeyCodeDown.subscribe,this.onKeyCodeUp=this.emitKeyCodeUp.subscribe,this.onKeyDown=this.emitKeyDown.subscribe,this.onKeyUp=this.emitKeyUp.subscribe,this.isPaused=!1,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}pause(){this.isPaused=!0}resume(){this.isPaused=!1}isPressed(e){return this.pressed.has(e)}getUserKey(e){return this.codeToKey.has(e)?this.codeToKey.get(e):null}dispose(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){this.onEvent(e),this.isPressed(e.code)||(this.pressed.add(e.code),this.isPaused||(this.emitKeyDown(e),this.emitKeyCodeDown(e.code,e)))}handleKeyUp(e){this.onEvent(e),this.isPressed(e.code)&&(this.pressed.delete(e.code),this.isPaused||(this.emitKeyUp(e),this.emitKeyCodeUp(e.code,e)))}onEvent(e){this.codeToKey.set(e.code,e.key)}}var r;!function(e){e.AltLeft="AltLeft",e.AltRight="AltRight",e.Backslash="Backslash",e.Backspace="Backspace",e.CapsLock="CapsLock",e.ControlLeft="ControlLeft",e.Enter="Enter",e.Escape="Escape",e.MetaLeft="MetaLeft",e.MetaRight="MetaRight",e.ShiftLeft="ShiftLeft",e.ShiftRight="ShiftRight",e.Tab="Tab",e.ArrowDown="ArrowDown",e.ArrowLeft="ArrowLeft",e.ArrowRight="ArrowRight",e.ArrowUp="ArrowUp",e.Backquote="Backquote",e.BracketLeft="BracketLeft",e.BracketRight="BracketRight",e.Comma="Comma",e.Equal="Equal",e.IntlBackslash="IntlBackslash",e.Minus="Minus",e.Period="Period",e.Quote="Quote",e.Semicolon="Semicolon",e.Slash="Slash",e.Space="Space",e.F1="F1",e.F2="F2",e.F3="F3",e.F4="F4",e.F5="F5",e.F6="F6",e.F7="F7",e.F8="F8",e.Digit0="Digit0",e.Digit1="Digit1",e.Digit2="Digit2",e.Digit3="Digit3",e.Digit4="Digit4",e.Digit5="Digit5",e.Digit6="Digit6",e.Digit7="Digit7",e.Digit8="Digit8",e.Digit9="Digit9",e.KeyA="KeyA",e.KeyB="KeyB",e.KeyC="KeyC",e.KeyD="KeyD",e.KeyE="KeyE",e.KeyF="KeyF",e.KeyG="KeyG",e.KeyH="KeyH",e.KeyI="KeyI",e.KeyJ="KeyJ",e.KeyK="KeyK",e.KeyL="KeyL",e.KeyM="KeyM",e.KeyN="KeyN",e.KeyO="KeyO",e.KeyP="KeyP",e.KeyQ="KeyQ",e.KeyR="KeyR",e.KeyS="KeyS",e.KeyT="KeyT",e.KeyU="KeyU",e.KeyV="KeyV",e.KeyW="KeyW",e.KeyX="KeyX",e.KeyY="KeyY",e.KeyZ="KeyZ"}(r||(r={}));class a{constructor(){this.keyboard=new o,this.keymap={},this.actions=new Set,this.emitChange=n(),this.emitActivate=i(),this.emitDeactivate=i(),this.onChange=this.emitChange.subscribe,this.onActivate=this.emitActivate.subscribe,this.onDeactivate=this.emitDeactivate.subscribe,this.handleKeyDown=this.handle(e=>{this.actions.has(e)||(this.actions.add(e),this.emitActivate(e),this.emitChange(Array.from(this.actions)))}),this.handleKeyUp=this.handle(e=>{this.actions.has(e)&&(this.actions.delete(e),this.emitDeactivate(e),this.emitChange(Array.from(this.actions)))}),this.subscriptions=[this.keyboard.onKeyDown(this.handleKeyDown),this.keyboard.onKeyUp(this.handleKeyUp)]}get isPaused(){return this.keyboard.isPaused}pause(){this.keyboard.pause()}resume(){this.keyboard.resume()}getUserKey(e){this.keyboard.getUserKey(e)}setKeyMap(e,t){this.keymap[e]=t}isActive(e){return this.actions.has(e)}dispose(){this.subscriptions.forEach(e=>e()),this.keyboard.dispose()}setDirections(e,t,s,i){this.setArrows(e,t,s,i),this.setWSAD(e,t,s,i)}setArrows(e,t,s,i){this.keymap[r.ArrowUp]=e,this.keymap[r.ArrowDown]=t,this.keymap[r.ArrowLeft]=s,this.keymap[r.ArrowRight]=i}setWSAD(e,t,s,i){this.keymap[r.KeyW]=e,this.keymap[r.KeyS]=t,this.keymap[r.KeyA]=s,this.keymap[r.KeyD]=i}getActionFor(e){return r[e]||console.log("Missing key code: "+e),this.keymap[e]}handle(e){return t=>{const s=this.getActionFor(t.code);null!=s&&e(s)}}}},function(e,t,s){"use strict";function i(){const e=new Set;return t.emit=function(t){e.forEach(e=>e(t))},t;function t(t){return e.add(t),()=>e.delete(t)}}s.r(t),s.d(t,"JsonSocket",(function(){return n}));class n{constructor(e){this.uri=e,this.RECONNECTION_DELAY=100,this.MAX_RECONNECT_ATTEMPTS=14,this.reconnectionDelay=100,this.reconnectAttempts=0,this.disconnectedAt=new Date,this.isReconnecting=!1,this.isFirstConnection=!0,this.ws=this.init(),this.onOpen=i(),this.onMessage=i(),this.onReconnect=i()}get isConnected(){return!this.isFirstConnection&&!this.isReconnecting}init(){const e=new WebSocket(this.uri);return e.onopen=()=>this.connectionOpen(),e.onmessage=e=>this.processMessage(e),e.onerror=()=>this.connectionLost(),e.onclose=()=>this.connectionLost(),e}send(e){this.ws.send(JSON.stringify(e))}processMessage(e){let t;try{t=JSON.parse(e.data)}catch(t){return void console.error("Invalid JSON",e.data)}this.onMessage.emit(t)}connectionOpen(){this.reconnectionDelay=this.RECONNECTION_DELAY,this.reconnectAttempts=0,this.isReconnecting=!1,this.isFirstConnection?(this.isFirstConnection=!1,this.onOpen.emit(this)):this.onReconnect.emit(this.disconnectedAt)}connectionLost(){if(this.isReconnecting)return;if(this.reconnectAttempts>this.MAX_RECONNECT_ATTEMPTS)return console.error(`Websocket aborted after ${this.reconnectAttempts} attempts`);0===this.reconnectAttempts&&(this.isReconnecting=!0,this.disconnectedAt=new Date);const e=`Socket closed. Waiting ${this.reconnectionDelay/1e3}s`,t="Reconnecting...",s=this.reconnectAttempts<1e3;console.debug(`${e} ${s?t:""}`),setTimeout(()=>{s||console.debug(t),this.reconnectionDelay*=2,this.reconnectAttempts++,this.ws=this.init()},this.reconnectionDelay)}close(){this.ws.onclose=null,this.ws.close()}}}]);
//# sourceMappingURL=main.js.map