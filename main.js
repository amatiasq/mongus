!function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=3)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deserializeEntity=t.serializeEntity=t.createEntity=t.EntityType=void 0;const s=i(1);var n;!function(e){e[e.Unknown=0]="Unknown",e[e.Player=1]="Player",e[e.DeadBody=2]="DeadBody"}(n=t.EntityType||(t.EntityType={})),t.createEntity=function(){return{type:n.Unknown,color:"#FFFFFF",position:{x:0,y:0},orientation:s.Orientation.Left}},t.serializeEntity=function({type:e,color:t,position:i,orientation:s}){return{type:e,color:t,position:i,orientation:s}},t.deserializeEntity=function(e,{type:t,color:i,position:s,orientation:n}){return e.type=t,e.color=i,e.position=s,e.orientation=n,e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Orientation=void 0,function(e){e[e.Left=0]="Left",e[e.Right=1]="Right"}(t.Orientation||(t.Orientation={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Color=void 0;const s=/^#([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})?$/,n=/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})?$/,o=/^rgb\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)$/,r=/^rgba\s*\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)$/,a=255;class c{constructor(e,t,i,s=1){this.r=e,this.g=t,this.b=i,this.a=s}static fromArray([e,t,i,s]){return new c(e,t,i,null==s?1:s)}static fromHex(e){const t=function(e){const t=s.exec(e)||n.exec(e);if(!t)throw new Error("Invalid HEX color "+e);const i=t.slice(1);i[3]=i[3]||"FF";const o=i.map(e=>{const t=2===e.length?e:e+e;return parseInt(t,16)});return o[3]/=255,o}(e.trim());return this.fromArray(t)}static fromRgb(e){const t=function(e){const t=o.exec(e)||r.exec(e);if(!t)throw new Error("Invalid RGB color "+e);const[i,s,n,a]=t.slice(1);return[parseFloat(i),parseFloat(s),parseFloat(n),null==a?1:parseFloat(a)]}(e.trim());return this.fromArray(t)}static fromImageData(e,t){return new c(e[t],e[t+1],e[t+2],e[t+3])}get hex(){return function(e){const t=e.toArray();1===t[3]?t.length--:t[3]=Math.round(t[3]*a);return"#"+t.map(e=>e.toString(16)).join("")}(this)}get rgb(){return`rgba(${this.toArray().join(", ")})`}get brightness(){return(.299*(e=this).r+.587*e.g+.114*e.b)/256;var e}get isLight(){return this.brightness>.5}get isDark(){return this.brightness<=.5}get isReddish(){return h(this.r,this.g,this.b)}get isBlueish(){return h(this.b,this.r,this.g)}get isGreenish(){return h(this.g,this.r,this.b)}isLigherThan(e){return this.brightness>e.brightness}isDarkerThan(e){return this.brightness<e.brightness}isEqual(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}shade(e){return new c(...this.toArray().map(t=>t*(1-e)))}setToImageData(e,t,i=!1){e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,i||(e[t+3]=255*this.a)}toArray(){const{r:e,g:t,b:i,a:s}=this;return[e,t,i,s]}toString(){return this.rgb}}function h(e,t,i){return e>10&&e>t&&e>i}t.Color=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(4),n=i(5),o=i(0),r=i(6),a=i(8),c=i(9),h=i(12),y=new a.ClientSocket("wss://amongus.amatiasq.com"),u=`${Math.random()}${Date.now()}${Math.random()}©AMONGUS®`;let l=[];function d(){console.log("users",l)}h.watchKeyboard(e=>y.send({type:s.ClientMessageType.USER_ACTIONS,actions:Array.from(e)})),y.onOpen(()=>y.send({type:s.ClientMessageType.LOGIN,uuid:u})),y.onReconnect(()=>y.send({type:s.ClientMessageType.RECONNECT,uuid:u})),y.onMessageType(n.ServerMessageType.LOGIN_SUCCESS,e=>{l=e.users.map(e=>new c.ClientUser(e,e.id===u)),d()}),y.onMessageType(n.ServerMessageType.USER_CONNECTED,e=>{l.push(new c.ClientUser(e.user)),d()}),y.onMessageType(n.ServerMessageType.USER_DISCONNECTED,e=>{const t=l.findIndex(t=>t.id===e.uuid);-1!==t&&(l.splice(t,1),d())}),y.onMessageType(n.ServerMessageType.GAME_STEP,e=>{const t=[],i=[];e.entities.forEach(e=>{e.type===o.EntityType.Player?t.push(e):i.push(e)}),r.render(t,i)}),window.onbeforeunload=()=>{y.send({type:s.ClientMessageType.LOGOUT})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientMessageType=void 0,function(e){e.ERROR="ERROR",e.LOGIN="LOGIN",e.LOGOUT="LOGOUT",e.RECONNECT="RECONNECT",e[e.USER_ACTIONS=1]="USER_ACTIONS"}(t.ClientMessageType||(t.ClientMessageType={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerMessageType=void 0,function(e){e.ERROR="ERROR",e.HANDSHAKE="HANDSHAKE",e.LOGIN_SUCCESS="LOGIN_SUCCESS",e.USER_CONNECTED="USER_CONNECTED",e.USER_DISCONNECTED="USER_DISCONNECTED",e.MESSAGE_FROM_USER="MESSAGE_FROM_USER",e.MESSAGE_TO_ROOM="MESSAGE_TO_ROOM",e[e.GAME_STEP=1]="GAME_STEP"}(t.ServerMessageType||(t.ServerMessageType={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.render=void 0;const s=i(1),n=i(2),o=i(7),r=document.querySelector("canvas"),a=r.getContext("2d"),c=new o.PlayerSprite("assets/sprites/player.png"),h=new o.PlayerSprite("assets/sprites/phantom.png"),y=new o.PlayerSprite("assets/sprites/body.png");function u(){r.width=window.innerWidth,r.height=window.innerHeight}u(),window.onresize=u,t.render=function(e,t){a.clearRect(0,0,r.width,r.height),t.forEach(e=>{const t=y.getColor(n.Color.fromHex(e.color));a.save(),a.translate(e.position.x,e.position.y),e.orientation===s.Orientation.Right&&a.scale(-1,1),a.drawImage(t,e.position.x-t.width/2,e.position.y-t.height/2),a.restore()}),e.forEach(e=>{const t=n.Color.fromHex(e.color),i=(e.isDead?h:c).getColor(t);a.save(),e.isDead&&(a.globalAlpha=.8),a.translate(e.position.x,e.position.y),e.orientation===s.Orientation.Left&&a.scale(-1,1),a.drawImage(i,-i.width/2,-i.height/2),a.globalAlpha=1,a.restore()})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayerSprite=void 0;const s=i(2);t.PlayerSprite=class{constructor(e){this.template=new Image,this.colors=new Map,this.isReady=!1,this.template.src=e,this.template.onload=()=>this.isReady=!0}get width(){return this.template.width}get height(){return this.template.height}getColor(e){if(!this.isReady)return this.template;const t=e.rgb;if(this.colors.has(t))return this.colors.get(t);const i=this.paintTemplate(e);return this.colors.set(t,i),i}paintTemplate(e){const t=e.shade(.5),i=document.createElement("canvas"),n=i.getContext("2d"),{width:o,height:r}=this.template;i.width=o,i.height=r,n.drawImage(this.template,0,0);const a=n.getImageData(0,0,o,r),{data:c}=a;for(let i=0,n=c.length;i<n;i+=4){const n=s.Color.fromImageData(c,i);n.isReddish?e.setToImageData(c,i,!0):n.isBlueish&&t.setToImageData(c,i,!0)}return n.putImageData(a,0,0),i}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientSocket=void 0;const s=i(15);class n extends s.JsonSocket{constructor(e){super(e),this.listeners=new Map,this.onMessage(e=>this.processMessagePotato(e))}onMessageType(e,t){this.listeners.has(e)?this.listeners.get(e).push(t):this.listeners.set(e,[t])}processMessagePotato(e){const t=this.listeners.get(e.type);console.debug(e.type,e),t?t.forEach(t=>t(e)):console.log("Unhandled message: "+e.type)}}t.ClientSocket=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientUser=void 0;const s=i(10);t.ClientUser=class{constructor(e,t=!1){this.isPlayer=t,s.deserializeUser(this,e)}toJSON(){return s.serializeUser(this)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deserializeUser=t.serializeUser=void 0;const s=i(11);t.serializeUser=function(e){return{id:e.id,player:s.serializePlayer(e.player)}},t.deserializeUser=function(e,t){return e.id=t.id,e.player=s.deserializePlayer(e.player||s.createPlayer(),t.player),e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deserializePlayer=t.serializePlayer=t.createPlayer=void 0;const s=i(0);t.createPlayer=function(){return{...s.createEntity(),type:s.EntityType.Player,isDead:!1}},t.serializePlayer=function(e){const{isDead:t}=e;return{...s.serializeEntity(e),type:s.EntityType.Player,isDead:t}},t.deserializePlayer=function(e,t){return s.deserializeEntity(e,t),e.type=s.EntityType.Player,e.isDead=t.isDead,e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.watchKeyboard=void 0;const s=i(14),n=i(13),o=new s.KeyboardActions;o.setDirections(n.Action.UP,n.Action.DOWN,n.Action.LEFT,n.Action.RIGHT),o.setKeyMap(s.KeyCode.KeyK,n.Action.KILL),t.watchKeyboard=function(e){o.onChange(t=>e(t))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Action=void 0,function(e){e[e.UP=0]="UP",e[e.DOWN=1]="DOWN",e[e.LEFT=2]="LEFT",e[e.RIGHT=3]="RIGHT",e[e.KILL=4]="KILL"}(t.Action||(t.Action={}))},function(e,t,i){"use strict";function s(){const e=new Map;return t.subscribe=function(t,i){const s=e.get(t)||new Set;i.length||e.set(t,s);return s.add(i),()=>s.delete(i)},t;function t(t,i){const s=e.get(t);s&&s.forEach(e=>e(i))}}function n(){const e=new Set;return t.subscribe=function(t){return e.add(t),()=>e.delete(t)},t;function t(t){e.forEach(e=>e(t))}}i.r(t),i.d(t,"KeyboardActions",(function(){return a})),i.d(t,"KeyboardController",(function(){return o})),i.d(t,"KeyCode",(function(){return r}));class o{constructor(){this.pressed=new Set,this.codeToKey=new Map,this.emitKeyCodeDown=s(),this.emitKeyCodeUp=s(),this.emitKeyDown=n(),this.emitKeyUp=n(),this.onKeyCodeDown=this.emitKeyCodeDown.subscribe,this.onKeyCodeUp=this.emitKeyCodeUp.subscribe,this.onKeyDown=this.emitKeyDown.subscribe,this.onKeyUp=this.emitKeyUp.subscribe,this.isPaused=!1,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}pause(){this.isPaused=!0}resume(){this.isPaused=!1}isPressed(e){return this.pressed.has(e)}getUserKey(e){return this.codeToKey.has(e)?this.codeToKey.get(e):null}dispose(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp)}handleKeyDown(e){this.onEvent(e),this.isPressed(e.code)||(this.pressed.add(e.code),this.isPaused||(this.emitKeyDown(e),this.emitKeyCodeDown(e.code,e)))}handleKeyUp(e){this.onEvent(e),this.isPressed(e.code)&&(this.pressed.delete(e.code),this.isPaused||(this.emitKeyUp(e),this.emitKeyCodeUp(e.code,e)))}onEvent(e){this.codeToKey.set(e.code,e.key)}}var r;!function(e){e.AltLeft="AltLeft",e.AltRight="AltRight",e.Backslash="Backslash",e.Backspace="Backspace",e.CapsLock="CapsLock",e.ControlLeft="ControlLeft",e.Enter="Enter",e.Escape="Escape",e.MetaLeft="MetaLeft",e.MetaRight="MetaRight",e.ShiftLeft="ShiftLeft",e.ShiftRight="ShiftRight",e.Tab="Tab",e.ArrowDown="ArrowDown",e.ArrowLeft="ArrowLeft",e.ArrowRight="ArrowRight",e.ArrowUp="ArrowUp",e.Backquote="Backquote",e.BracketLeft="BracketLeft",e.BracketRight="BracketRight",e.Comma="Comma",e.Equal="Equal",e.IntlBackslash="IntlBackslash",e.Minus="Minus",e.Period="Period",e.Quote="Quote",e.Semicolon="Semicolon",e.Slash="Slash",e.Space="Space",e.F1="F1",e.F2="F2",e.F3="F3",e.F4="F4",e.F5="F5",e.F6="F6",e.F7="F7",e.F8="F8",e.Digit0="Digit0",e.Digit1="Digit1",e.Digit2="Digit2",e.Digit3="Digit3",e.Digit4="Digit4",e.Digit5="Digit5",e.Digit6="Digit6",e.Digit7="Digit7",e.Digit8="Digit8",e.Digit9="Digit9",e.KeyA="KeyA",e.KeyB="KeyB",e.KeyC="KeyC",e.KeyD="KeyD",e.KeyE="KeyE",e.KeyF="KeyF",e.KeyG="KeyG",e.KeyH="KeyH",e.KeyI="KeyI",e.KeyJ="KeyJ",e.KeyK="KeyK",e.KeyL="KeyL",e.KeyM="KeyM",e.KeyN="KeyN",e.KeyO="KeyO",e.KeyP="KeyP",e.KeyQ="KeyQ",e.KeyR="KeyR",e.KeyS="KeyS",e.KeyT="KeyT",e.KeyU="KeyU",e.KeyV="KeyV",e.KeyW="KeyW",e.KeyX="KeyX",e.KeyY="KeyY",e.KeyZ="KeyZ"}(r||(r={}));class a{constructor(){this.keyboard=new o,this.keymap={},this.actions=new Set,this.emitChange=n(),this.emitActivate=s(),this.emitDeactivate=s(),this.onChange=this.emitChange.subscribe,this.onActivate=this.emitActivate.subscribe,this.onDeactivate=this.emitDeactivate.subscribe,this.handleKeyDown=this.handle(e=>{this.actions.has(e)||(this.actions.add(e),this.emitActivate(e),this.emitChange(Array.from(this.actions)))}),this.handleKeyUp=this.handle(e=>{this.actions.has(e)&&(this.actions.delete(e),this.emitDeactivate(e),this.emitChange(Array.from(this.actions)))}),this.subscriptions=[this.keyboard.onKeyDown(this.handleKeyDown),this.keyboard.onKeyUp(this.handleKeyUp)]}get isPaused(){return this.keyboard.isPaused}pause(){this.keyboard.pause()}resume(){this.keyboard.resume()}getUserKey(e){this.keyboard.getUserKey(e)}setKeyMap(e,t){this.keymap[e]=t}isActive(e){return this.actions.has(e)}dispose(){this.subscriptions.forEach(e=>e()),this.keyboard.dispose()}setDirections(e,t,i,s){this.setArrows(e,t,i,s),this.setWSAD(e,t,i,s)}setArrows(e,t,i,s){this.keymap[r.ArrowUp]=e,this.keymap[r.ArrowDown]=t,this.keymap[r.ArrowLeft]=i,this.keymap[r.ArrowRight]=s}setWSAD(e,t,i,s){this.keymap[r.KeyW]=e,this.keymap[r.KeyS]=t,this.keymap[r.KeyA]=i,this.keymap[r.KeyD]=s}getActionFor(e){return r[e]||console.log("Missing key code: "+e),this.keymap[e]}handle(e){return t=>{const i=this.getActionFor(t.code);null!=i&&e(i)}}}},function(e,t,i){"use strict";function s(){const e=new Set;return t.emit=function(t){e.forEach(e=>e(t))},t;function t(t){return e.add(t),()=>e.delete(t)}}i.r(t),i.d(t,"JsonSocket",(function(){return n}));class n{constructor(e){this.uri=e,this.RECONNECTION_DELAY=100,this.MAX_RECONNECT_ATTEMPTS=14,this.reconnectionDelay=100,this.reconnectAttempts=0,this.disconnectedAt=new Date,this.isReconnecting=!1,this.isFirstConnection=!0,this.ws=this.init(),this.onOpen=s(),this.onMessage=s(),this.onReconnect=s()}get isConnected(){return!this.isFirstConnection&&!this.isReconnecting}init(){const e=new WebSocket(this.uri);return e.onopen=()=>this.connectionOpen(),e.onmessage=e=>this.processMessage(e),e.onerror=()=>this.connectionLost(),e.onclose=()=>this.connectionLost(),e}send(e){this.ws.send(JSON.stringify(e))}processMessage(e){let t;try{t=JSON.parse(e.data)}catch(t){return void console.error("Invalid JSON",e.data)}this.onMessage.emit(t)}connectionOpen(){this.reconnectionDelay=this.RECONNECTION_DELAY,this.reconnectAttempts=0,this.isReconnecting=!1,this.isFirstConnection?(this.isFirstConnection=!1,this.onOpen.emit(this)):this.onReconnect.emit(this.disconnectedAt)}connectionLost(){if(this.isReconnecting)return;if(this.reconnectAttempts>this.MAX_RECONNECT_ATTEMPTS)return console.error(`Websocket aborted after ${this.reconnectAttempts} attempts`);0===this.reconnectAttempts&&(this.isReconnecting=!0,this.disconnectedAt=new Date);const e=`Socket closed. Waiting ${this.reconnectionDelay/1e3}s`,t="Reconnecting...",i=this.reconnectAttempts<1e3;console.debug(`${e} ${i?t:""}`),setTimeout(()=>{i||console.debug(t),this.reconnectionDelay*=2,this.reconnectAttempts++,this.ws=this.init()},this.reconnectionDelay)}close(){this.ws.onclose=null,this.ws.close()}}}]);
//# sourceMappingURL=main.js.map